<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F1 Growth Celebration – Self Check‑in</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --primary:#2563eb; --primary-2:#1d4ed8; --ring:#93c5fd; --danger:#b91c1c; --danger-bg:#fee2e2; --danger-br:#fecaca;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(#fff,#f8fafc);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:#ffffffd9;backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:860px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 18px rgba(15,23,42,.06)}
    .card .content{padding:18px}
    h1{font-size:20px;margin:0;font-weight:700}
    h2{font-size:18px;margin:0 0 8px 0}
    p{margin:0 0 8px 0;color:var(--muted)}
    button{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    button.primary:active{transform:translateY(1px)}
    button.secondary{background:#f1f5f9}
    button:focus{outline:3px solid var(--ring);outline-offset:2px}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    input:focus,select:focus{outline:3px solid var(--ring);border-color:var(--primary)}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    .error{color:var(--danger)}
    .hidden{display:none !important}
    .list{display:grid;gap:8px}
    .list .item{display:flex;justify-content:space-between;align-items:center}
    .big{font-size:26px;font-weight:800}
    .xl{font-size:22px;font-weight:700}
    .lang-toggle button{padding:8px 10px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
    .chip.danger{background:var(--danger-bg);border-color:var(--danger-br);color:var(--danger)}
    .foot{padding:28px;text-align:center;color:var(--muted);font-size:12px}
    .suggest{display:grid;gap:8px}
    .suggest button{justify-content:flex-start}
    @media (min-width:700px){ .two{grid-template-columns:1fr 1fr} }
  </style>
  <!-- Excel library with CDN → local fallback -->
  <script>
    (function(){
      function inject(src, onload){ var s=document.createElement('script'); s.src=src; s.defer=true; s.onload=onload; s.onerror=function(){ console.warn('Failed to load', src); var eb=document.getElementById('errorBanner'); if(eb){ eb.classList.remove('hidden'); eb.textContent='Error loading '+src; } }; document.head.appendChild(s); }
      // Try CDN first; if blocked by CSP, fall back to local file next to index.html
      inject('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js', function(){ window.__xlsxReady=true; });
      setTimeout(function(){ if(!window.__xlsxReady){ inject('./xlsx.full.min.js', function(){ window.__xlsxReady=true; }); } }, 1200);
    })();
  </script>
  <!-- Traditional/Simplified Chinese conversion (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
</head>
<body>
  <header>
    <div class="container row" style="align-items:center;justify-content:space-between;">
      <div class="row" style="align-items:center;gap:10px">
        <h1 id="title">F1 Growth Celebration Ceremony</h1>
        <span class="pill" id="datePill">25/10/2025</span>
      </div>
      <div class="row lang-toggle">
        <span class="muted" id="langLabel">Language</span>
        <button id="btnEn" class="secondary">English</button>
        <button id="btnZh" class="secondary">中文</button>
        <button id="btnAdmin" class="primary">Staff</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:16px;">
    <!-- HOME (kept for title/intro; no Start button) -->
    <section id="pageHome">
      <div class="card"><div class="content grid">
        <div class="xl" id="homeTitle">F1 Growth Celebration Ceremony</div>
        <p id="homeIntro">Please check in here when you arrive at the school hall to see your classroom meeting venue.</p>
      </div></div>
    </section>

    <!-- FLOW (shown by default) -->
    <section id="pageFlow">
      <div class="card"><div class="content grid">
        <div id="cloudBanner" class="chip hidden"></div>
        <div id="errorBanner" class="chip danger hidden"></div>
        <div id="rosterStatus" class="muted"></div>
        <div>
          <label id="labelSelectClass">Select Class</label>
          <select id="selectClass"><option value="" id="optChoose">Choose</option></select>
        </div>
        <div class="btns">
          <button id="modeNumber" class="primary">Class No.</button>
          <button id="modeName" class="secondary">Choose from list</button>
        </div>
        <div id="panelNumber" class="grid">
          <label id="labelEnterNo">Enter class number (e.g., 12)</label>
          <input id="inputNumber" inputmode="numeric" pattern="[0-9]*" placeholder="12" />
          <button id="btnConfirmByNo" class="primary">Confirm student</button>
        </div>
        <div id="panelName" class="grid hidden">
          <label id="labelStudentName">Student name</label>
          <select id="selectStudent"><option value="" id="optStudentChoose">Choose a student</option></select>
        </div>
      </div></div>
    </section>

    <div id="cardPicked" class="card hidden"><div class="content grid">
      <div class="xl" id="pickedLine">Student: –</div>
      <div class="muted" id="pickedGroup">Group: –</div>
      <div class="muted">Venue: <span id="pickedVenue" style="font-weight:700"></span></div>
      <div id="alreadyWarn" class="chip danger hidden"></div>
      <div>
        <label id="labelParents">No. of parents attending</label>
        <input id="inputParents" type="number" inputmode="numeric" pattern="[0-9]*" min="1" max="4" step="1" value="1" oninput="var v=parseInt(this.value||'1',10); if(isNaN(v)) v=1; if(v<1) v=1; if(v>4) v=4; this.value=v;" />
      </div>
      <div class="btns">
        <button id="btnConfirmAttendance" class="primary">Confirm attendance</button>
        <button id="btnBack" class="secondary">Back</button>
      </div>
    </div></div>

    <div id="cardDone" class="card hidden"><div class="content grid">
      <div class="xl" id="doneTitle">Attendance confirmed</div>
      <div class="muted" id="doneSub">Student: –</div>
      <div class="muted" id="donePrompt">After the briefing, please proceed to your designated room:</div>
      <div class="big" id="doneVenue">M42</div>
      <div class="btns">
        <button id="btnDoneBack" class="primary">Back</button>
        <button id="btnDoneReset" class="secondary">Reset</button>
      </div>
    </div></div>

    <!-- ADMIN LOCK -->
    <section id="pageAdmin" class="hidden">
      <div class="card"><div class="content grid">
        <h2 id="adminTitle">Staff mode</h2>
        <label id="labelPIN">Enter PIN</label>
        <input id="inputPIN" inputmode="numeric" />
        <div class="btns">
          <button id="btnUnlock" class="primary">Unlock</button>
          <button id="btnAdminBack" class="secondary">Back</button>
        </div>
      </div></div>
    </section>

    <!-- ADMIN UNLOCKED -->
    <section id="pageAdminOpen" class="hidden">
      <div class="card"><div class="content grid">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="xl" id="adminOpenTitle">Staff mode</div>
          <div class="btns">
            <button id="btnExport" class="primary">Export CSV</button>
            <button id="btnLock" class="secondary">Lock</button>
          </div>
        </div>
        <div class="two grid">
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalParents">Total parents checked-in</div>
            <div class="big" id="totalParents">0</div>
          </div></div>
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalFamilies">Total families checked-in</div>
            <div class="big" id="totalFamilies">0</div>
          </div></div>
        </div>
        <input id="adminSearch" placeholder="Search…" />
        <div class="list" id="adminList"></div>
      </div></div>
    </section>

    <div class="foot">© 2025 F1 Growth Celebration</div>
  </main>

  <script>
  // ====== CONFIG ======
  const ADMIN_PIN = "1025"; // Change if desired
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxzjfbVE0LZ-cIeEC9Szmm_cRPKoyBjwnhgZcvPhXEbw6BT9R3ixT23IRu7ApQ7nobSSw/exec'; // <-- Google Apps Script Web App /exec URL

  // Global error banner (helps catch syntax/runtime errors that would keep Flow hidden)
  (function(){
    var shown=false;
    function show(err){ try{ var n=document.getElementById('errorBanner'); if(n && !shown){ n.textContent='Error: '+String(err); n.classList.remove('hidden'); shown=true; } }catch(_){}}
    window.addEventListener('error', e=>show(e && (e.message||e.error) || 'unknown error'));
    window.addEventListener('unhandledrejection', e=>show(e && e.reason ? e.reason : 'Promise rejected'));
  })();

  // ====== I18N ======
  const I18N = {
    en: {
      appTitle: "F1 Growth Celebration Ceremony",
      intro1: "Please check in here when you arrive at the school hall to see your classroom meeting venue.",
      start: "Start",
      setup: "Setup",
      language: "Language",
      english: "English",
      chinese: "中文",
      selectClass: "Select Class",
      choose: "Choose",
      chooseStudent: "Choose a student",
      classNo: "Class No.",
      or: "or",
      searchByName: "Choose from list",
      enterNumber: "Enter class number (e.g., 12)",
      studentName: "Student name",
      noMatch: "No matching student",
      confirmStudent: "Confirm student",
      student: "Student",
      group: "Group",
      venue: "Meeting venue",
      odd: "Odd",
      even: "Even",
      parentsAttending: "No. of parents attending",
      confirmAttendance: "Confirm attendance",
      attendanceConfirmed: "Attendance confirmed",
      proceedToVenue: "After the briefing, please proceed to your designated room:",
      back: "Back",
      reset: "Reset",
      admin: "Staff mode",
      adminPIN: "Enter PIN",
      unlock: "Unlock",
      lock: "Lock",
      exportCSV: "Export CSV",
      totalParents: "Total parents checked-in",
      totalFamilies: "Total families checked-in",
      loadRoster: "Upload roster (Excel)",
      loadJSON: "Upload JSON",
      loadSample: "Load sample data",
      setupTitle: "Setup: Load roster",
      setupDesc: "This app will try to auto‑load your roster from ./roster.xlsx (or use ?roster=<url>). You can also upload the Excel with a 'roster' sheet (columns: class, number, en_name, ch_name, group, venue, parents_expected). Data is stored locally on this device only.",
      continue: "Continue",
      qrPoster: "QR poster",
      appLink: "App link",
      copy: "Copy",
      copied: "Copied!",
      changeLanguage: "Change language",
      staff: "Staff",
      alreadyCheckedIn: "Already checked in",
      duplicateMsg: "This student has already checked in. Showing venue again.",
      loadFail: "Could not load roster.xlsx in this folder.",
      loadSuccess: "Roster loaded. You may check in now.",
    },
    zh: {
      appTitle: "中一成長祝福禮",
      intro1: "到達禮堂時，請在此自行簽到，以查看活動教室地點。",
      start: "開始",
      setup: "設定",
      language: "語言",
      english: "English",
      chinese: "中文",
      selectClass: "選擇班別",
      choose: "請選擇",
      chooseStudent: "請選擇學生",
      classNo: "學號",
      or: "或",
      searchByName: "從名單選擇",
      enterNumber: "輸入學號（例如：12）",
      studentName: "學生姓名",
      noMatch: "找不到相符學生",
      confirmStudent: "確認學生",
      student: "學生",
      group: "組別",
      venue: "集合地點",
      odd: "單號",
      even: "雙號",
      parentsAttending: "到場家長人數",
      confirmAttendance: "確認出席",
      attendanceConfirmed: "已完成簽到",
      proceedToVenue: "簡介會結束後，請前往指定課室：",
      back: "返回",
      reset: "重設",
      admin: "職員模式",
      adminPIN: "輸入密碼",
      unlock: "解鎖",
      lock: "上鎖",
      exportCSV: "匯出 CSV",
      totalParents: "已簽到家長總數",
      totalFamilies: "已簽到家庭數",
      loadRoster: "上載名單（Excel）",
      loadJSON: "上載 JSON",
      loadSample: "載入示例資料",
      setupTitle: "設定：載入名單",
      setupDesc: "本應用會嘗試自動載入 ./roster.xlsx（或使用網址參數 ?roster=<連結>）。亦可上載含「roster」工作表的 Excel（欄位：class, number, en_name, ch_name, group, venue, parents_expected）。資料只儲存在本機裝置。",
      continue: "繼續",
      qrPoster: "二維碼海報",
      appLink: "應用連結",
      copy: "複製",
      copied: "已複製！",
      changeLanguage: "切換語言",
      staff: "職員",
      alreadyCheckedIn: "已簽到",
      duplicateMsg: "此學生已簽到，現再次顯示集合地點。",
      loadFail: "未能載入 roster.xlsx。",
      loadSuccess: "已載入名單，可開始簽到。",
    },
  };

  function t(key){ return I18N[state.lang][key]; }

  // ====== State & Storage ======
  const state = {
    lang: localStorage.getItem('f1.lang') || 'en',
    roster: null, // { classes: { '1B': { odd:{venue,students}, even:{...} } } }
    picked: null, // { classId, number, label, group, venue }
    checkins: [],
  };

  function loadCheckins(){ try{return JSON.parse(localStorage.getItem('f1.checkins')||'[]')}catch{return[]} }
  function saveCheckins(list){ localStorage.setItem('f1.checkins', JSON.stringify(list)); }
  function hasCheckedIn(classId, number){ return loadCheckins().some(r => r.classId===classId && Number(r.number)===Number(number)); }

  // ====== Cloud sync (Google Apps Script) ======
  function cloudEnabled(){ return BACKEND_URL && BACKEND_URL.indexOf('/exec')>0; }
  function cloudBanner(){ var n=el('cloudBanner'); if(!n) return; n.classList.remove('hidden'); n.classList.remove('danger'); var onTxt = (state.lang==='zh'?'雲端同步：開啟':'Cloud sync ON'); var offTxt = (state.lang==='zh'?'雲端同步：關閉（只存此裝置）':'Cloud sync OFF — local only'); n.textContent = cloudEnabled()? onTxt : offTxt; if(!cloudEnabled()){ n.classList.add('danger'); } }
  // POST check-in via URL-encoded body to avoid CORS preflight
  function cloudCheckin(record){
    if(!cloudEnabled()) return Promise.resolve({status:'local-only'});
    var body = new URLSearchParams(); body.set('action','checkin'); body.set('json', JSON.stringify(record));
    return fetch(BACKEND_URL, { method:'POST', body }).then(function(r){ return r.json(); }).catch(function(){ return {status:'error'}; });
  }
  function cloudList(){
    if(!cloudEnabled()) return Promise.resolve({status:'ok', items:[]});
    return fetch(BACKEND_URL+'?action=list', { cache:'no-store' }).then(function(r){ return r.json(); }).catch(function(){ return {status:'offline', items:[]}; });
  }

  // ====== DOM ======
  const el = (id)=>document.getElementById(id);
  const pages = ['Home','Flow','Admin','AdminOpen'];
  function show(page){ pages.forEach(p=> { const node = el('page'+p); if(node) node.classList.toggle('hidden', p!==page); }); }

  // Safe setters (avoid null element crashes)
  function setText(id, text){ const n=el(id); if(n){ n.textContent = text; return true; } console.warn('[setText] missing #'+id); return false; }
  function setHTML(id, html){ const n=el(id); if(n){ n.innerHTML = html; return true; } console.warn('[setHTML] missing #'+id); return false; }

  // ====== CJK-insensitive search helpers (Traditional/Simplified tolerant if OpenCC is present)
  let _convT2S = null, _convS2T = null;
  try {
    if (window.OpenCC && typeof OpenCC.Converter === 'function') {
      _convT2S = OpenCC.Converter({ from: 'tw', to: 'cn' });
      _convS2T = OpenCC.Converter({ from: 'cn', to: 'tw' });
    }
  } catch (e) { console.warn('OpenCC init failed', e); }
  const normBase = s => String(s||'').normalize('NFKC').toLowerCase().replace(/\s+/g,'');
  const variants = s => { const out = new Set([normBase(s)]); try{ if(_convT2S) out.add(normBase(_convT2S(s))); }catch{} try{ if(_convS2T) out.add(normBase(_convS2T(s))); }catch{} return out; };
  function matchCJKInsensitive(query, candidate){
    const qv = variants(query); const cv = variants(candidate);
    for(const q of qv){ for(const c of cv){ if(c.includes(q)) return true; } }
    return false;
  }

  // ====== App chrome / language / render ======
  function setLang(lang){ state.lang = lang; localStorage.setItem('f1.lang', lang); renderAll(); }
  function fillClassSelect(){
    const sel = el('selectClass'); if(!sel) return;
    const keep = sel.value;
    sel.innerHTML = `<option value="">${t('choose')}</option>`;
    if(state.roster){
      Object.keys(state.roster.classes).sort().forEach(c=>{
        const opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);
      });
      if(Object.keys(state.roster.classes).includes(keep)) sel.value = keep;
      populateStudentsUI();
    }
  }
  function renderAll(){
    setText('title', t('appTitle'));
    setText('langLabel', t('language'));
    setText('btnAdmin', t('staff'));
    // flow labels
    setText('labelSelectClass', t('selectClass'));
    setText('optChoose', t('choose'));
    setText('modeNumber', t('classNo'));
    setText('modeName', t('searchByName'));
    setText('labelEnterNo', t('enterNumber'));
    setText('btnConfirmByNo', t('confirmStudent'));
    setText('labelStudentName', t('studentName'));
    setText('labelParents', t('parentsAttending'));
    setText('btnConfirmAttendance', t('confirmAttendance'));
    setText('btnBack', t('back'));
    // done card
    setText('doneTitle', t('attendanceConfirmed'));
    setText('donePrompt', t('proceedToVenue'));
    setText('btnDoneBack', t('back'));
    setText('btnDoneReset', t('reset'));
    // admin
    setText('adminTitle', t('admin'));
    setText('labelPIN', t('adminPIN'));
    setText('btnUnlock', t('unlock'));
    setText('btnAdminBack', t('back'));
    setText('adminOpenTitle', t('admin'));
    setText('btnExport', t('exportCSV'));
    setText('btnLock', t('lock'));
    setText('labelTotalParents', t('totalParents'));
    setText('labelTotalFamilies', t('totalFamilies'));
    setText('optStudentChoose', t('chooseStudent'));
    fillClassSelect();
  }
  async function tryAutoLoad(){
    if(state.roster) return;
    // Wait for XLSX to be ready (up to ~3s)
    for(let i=0;i<30 && typeof XLSX==='undefined';i++){ await new Promise(r=>setTimeout(r,100)); }
    if(typeof XLSX==='undefined'){
      setText('rosterStatus', (state.lang==='zh'?'未能載入 Excel 程式庫。請允許載入外部腳本或把 xlsx.full.min.js 放在同一資料夾。':'Failed to load Excel parser. Allow external scripts or place xlsx.full.min.js beside index.html.'));
      return;
    }
    const params = new URLSearchParams(location.search);
    const rosterParam = params.get('roster')||params.get('xls')||params.get('excel');
    const candidates = [];
    if(rosterParam) candidates.push(rosterParam);
    candidates.push('./roster.xlsx');
    for(const u of candidates){
      try{
        const data = await loadRosterFromUrl(u);
        state.roster = data;
        localStorage.setItem('f1.roster', JSON.stringify(data));
        break;
      }catch(e){ console.warn('Auto-load failed for', u, e); var eb=document.getElementById('errorBanner'); if(eb){ eb.classList.remove('hidden'); eb.textContent='Error: '+e; } }
    }
    fillClassSelect();
    updateStartAvailability();
  }catch(e){ console.warn('Auto-load failed for', u, e); }
    }
    fillClassSelect();
    updateStartAvailability();
  }

  // ====== Roster handling ======
  function displayLabel(stu){
    // Strip zero-width characters that can sneak in from Excel/CSV and render as blank on iOS
    var stripZW = function(s){ return String(s||'').replace(/[\u200B\u200C\u200D\uFEFF]/g,''); };
    var ch = stripZW(stu && stu.ch_name || '').trim();
    var en = stripZW(stu && stu.en_name || '').trim();
    if(ch && en) return ch + ' / ' + en;
    return ch || en || '';
  }

  function normalizeRow(r){
    // Robust header + value normalization (fixes iPhone/Safari Excel header issues)
    // Handle NBSP (U+00A0), spaces/underscores, and casing in header names
    const NBSP_CHAR = String.fromCharCode(160);
    const normalizeKey = k => String(k||'')
      .toLowerCase()
      .split(NBSP_CHAR).join(' ')
      .replace(/[_ ]+/g,'')
      .trim();
    const pickAny = (obj, candidates)=>{
      if(!obj) return undefined;
      const map = new Map();
      for(const key of Object.keys(obj)) map.set(normalizeKey(key), key);
      for(const c of candidates){ const nk = normalizeKey(c); if(map.has(nk)) return obj[map.get(nk)]; }
      return undefined;
    };
    const toStr = v => String(v==null? '': v).split(NBSP_CHAR).join(' ').trim();

    // Class & number
    const cls = toStr(pickAny(r, ['class','Class','CLASS']));
    const numberRaw = pickAny(r, ['number','Number','no','No','NO','class_no','classno']);
    const number = Number(numberRaw||0);

    // Names (tolerate many header variants & hidden NBSP/space issues)
    const en = toStr(pickAny(r, [
      'en_name','enName','EN_NAME','english','English','english_name','englishname',
      'name_en','student_english','studentenglish','English Name','EnglishName'
    ]));
    const ch = toStr(pickAny(r, [
      'ch_name','chName','CH_NAME','chinese','Chinese','chinesename','chinese_name',
      'name_ch','chi_name','student_chinese','studentchinese','中文姓名','CH Name','CHName'
    ]));

    // Group & venue
    const gRaw = toStr(pickAny(r, ['group','Group'])).toLowerCase();
    const group = gRaw.includes('odd') ? 'odd' : gRaw.includes('even') ? 'even' : (number%2? 'odd':'even');
    const venue = toStr(pickAny(r, ['venue','Venue','room','Room','classroom']));

    // Expected parents
    const parentsRaw = pickAny(r, ['parents_expected','expected_parents','parents','no_of_parents','parents_coming','parent_count','ParentCount','Parents','Expected Parents']);
    const parentsNum = Number(parentsRaw||0);

    return { cls, number, en_name: en, ch_name: ch, group, venue, parents_expected: (Number.isFinite(parentsNum) && parentsNum>0) ? parentsNum : 0 };
  }

  function buildData(rows){
    const data = { classes:{} };
    rows.forEach(row=>{
      const { cls, number, en_name, ch_name, group, venue, parents_expected } = normalizeRow(row);
      if(!cls||!number||(!en_name && !ch_name)) return;
      if(!data.classes[cls]) data.classes[cls] = { odd:{venue:null,students:[]}, even:{venue:null,students:[]} };
      const bucket = data.classes[cls][group];
      if(!bucket.venue && venue) bucket.venue = venue;
      const display_name = (ch_name && en_name) ? `${ch_name} / ${en_name}` : (ch_name || en_name);
      bucket.students.push({ number, en_name, ch_name, display_name, expected_parents: (Number.isFinite(parents_expected) && parents_expected>0) ? Number(parents_expected) : null });
    });
    Object.values(data.classes).forEach(cb=>{
      cb.odd.students.sort((a,b)=>a.number-b.number);
      cb.even.students.sort((a,b)=>a.number-b.number);
    });
    return data;
  }

  async function parseExcelArrayBuffer(buf){
    const wb = XLSX.read(new Uint8Array(buf), { type:'array' });
    const ws = wb.Sheets['roster'] || wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error('No sheets found');
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
    return buildData(rows);
  }

  async function loadRosterFromUrl(url){
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    if(/\.json($|\?)/i.test(url)){
      const j = await res.json();
      return j;
    } else {
      const ab = await res.arrayBuffer();
      return await parseExcelArrayBuffer(ab);
    }
  }

  function updateStartAvailability(){
    if(state.roster){
      setText('rosterStatus', t('loadSuccess'));
    } else {
      setText('rosterStatus', t('loadFail'));
    }
    // Refresh class list when roster becomes available
    fillClassSelect();
  }

  function suggestionsFor(cls, query){
    if(!state.roster || !cls || !query) return [];
    const cb = state.roster.classes[cls]; if(!cb) return [];
    const list = [...cb.odd.students, ...cb.even.students];
    // match against both EN and CH names (Traditional/Simplified tolerant)
    return list.filter(s=>{
      const en = s.en_name||''; const ch = s.ch_name||''; const disp = s.display_name||'';
      return matchCJKInsensitive(query, ch) || matchCJKInsensitive(query, en) || matchCJKInsensitive(query, disp);
    }).slice(0,8);
  }

  function populateStudentsUI(){
    const cls = (el('selectClass') && el('selectClass').value) || '';
    const sel = el('selectStudent');
    if(!sel){ return; }
    sel.innerHTML = `<option value="">${t('chooseStudent')}</option>`;
    if(!state.roster || !cls || !state.roster.classes[cls]) return;
    const cb = state.roster.classes[cls];
    const makeOption = (s, group, venue) => {
      const opt = document.createElement('option');
      opt.value = String(s.number);
      const labelCore = displayLabel(s) || `#${s.number}`;
      const grpText = group==='odd'?t('odd'):t('even');
      const text = `${labelCore} (#${s.number} • ${grpText})${hasCheckedIn(cls, s.number) ? ' ✓' : ''}`;
      // Set all the possible properties so iOS Safari and other engines consistently show names
      opt.label = text;         // iOS picker prefers this
      opt.text = text;          // legacy
      opt.textContent = text;   // modern
      opt.innerText = text;     // extra safety
      opt.dataset.group = group;
      opt.dataset.venue = venue || '';
      opt.dataset.expected = (s.expected_parents!=null) ? String(s.expected_parents) : '';
      return opt;
    };
    cb.odd.students.forEach(s=> sel.appendChild(makeOption(s,'odd', cb.odd.venue)));
    cb.even.students.forEach(s=> sel.appendChild(makeOption(s,'even', cb.even.venue)));
  }

  function findByNumber(cls, n){
    const cb = state.roster.classes[cls]; if(!cb) return null;
    const sOdd = cb.odd.students.find(s=>s.number===n);
    if(sOdd) return { classId:cls, number:n, label: displayLabel(sOdd), group:'odd', venue: cb.odd.venue||'', expected_parents: sOdd.expected_parents };
    const sEven = cb.even.students.find(s=>s.number===n);
    if(sEven) return { classId:cls, number:n, label: displayLabel(sEven), group:'even', venue: cb.even.venue||'', expected_parents: sEven.expected_parents };
    return null;
  }

  function findByName(cls, nameOrDisplay){
    const cb = state.roster.classes[cls]; if(!cb) return null;
    const all=[...cb.odd.students,...cb.even.students];
    const s = all.find(x=> x.display_name===nameOrDisplay || x.en_name===nameOrDisplay || x.ch_name===nameOrDisplay);
    if(!s) return null;
    const inOdd = cb.odd.students.some(st=>st.number===s.number);
    const group = inOdd? 'odd':'even';
    const venue = inOdd? (cb.odd.venue||'') : (cb.even.venue||'');
    return { classId:cls, number:s.number, label: displayLabel(s), group, venue, expected_parents: s.expected_parents };
  }

  function updatePickedCard(){
    const c = state.picked; if(!c){ const card=el('cardPicked'); if(card) card.classList.add('hidden'); return; }
    setText('pickedLine', `${t('student')}: ${c.label} (${c.classId} #${c.number})`);
    setText('pickedGroup', `${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`);
    setText('pickedVenue', c.venue||'');
    const exists = hasCheckedIn(c.classId, c.number);
    const warnEl = el('alreadyWarn');
    const btn = el('btnConfirmAttendance');
    const ip = el('inputParents');
    if(warnEl){
      if(exists){ warnEl.textContent = t('alreadyCheckedIn'); warnEl.classList.remove('hidden'); if(btn) btn.disabled=true; }
      else { warnEl.classList.add('hidden'); if(btn) btn.disabled=false; }
    }
    if(ip && !exists){
      var _pre = (c.expected_parents && Number(c.expected_parents)>0) ? Number(c.expected_parents) : 1;
      ip.value = String(Math.min(4, Math.max(1, _pre)));
    }
    const card=el('cardPicked'); if(card) card.classList.remove('hidden');
  }

  function confirmAttendance(){
    const p = Math.min(4, Math.max(1, parseInt((el('inputParents')&&el('inputParents').value)||'1',10) || 1));
    const c = state.picked; if(!c) return;
    const record = { ts: Date.now(), classId:c.classId, number:c.number, name:c.label, group:c.group, venue:c.venue, parents: p, lang: state.lang };
    cloudCheckin(record).then(function(resp){
      if(resp && resp.status==='duplicate'){
        setText('doneTitle', (state.lang==='zh'?'已簽到':'Already checked in'));
      } else if(resp && resp.status==='ok'){
        setText('doneTitle', t('attendanceConfirmed'));
      } else if(resp && resp.status==='local-only'){
        const list = loadCheckins(); list.push(record); saveCheckins(list);
        setText('doneTitle', t('attendanceConfirmed')+' (local)');
      } else {
        const list2 = loadCheckins(); list2.push(record); saveCheckins(list2);
        setText('doneTitle', t('attendanceConfirmed')+' (saved locally – will not appear in Staff totals)');
      }
      setText('doneSub', `${t('student')}: ${record.name} (${record.classId} #${record.number}) • ${t('group')}: ${record.group==='odd'?t('odd'):t('even')}`);
      setText('doneVenue', record.venue);
      const cp=el('cardPicked'); if(cp) cp.classList.add('hidden');
      const cd=el('cardDone'); if(cd) cd.classList.remove('hidden');
      state.picked = null;
    });
  }: ${c.label} (${c.classId} #${c.number}) • ${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`);
      setText('doneVenue', c.venue);
      const cp=el('cardPicked'); if(cp) cp.classList.add('hidden');
      const cd=el('cardDone'); if(cd) cd.classList.remove('hidden');
      return;
    }
    const record = { ts: Date.now(), classId:c.classId, number:c.number, name:c.label, group:c.group, venue:c.venue, parents: p, lang: state.lang };
    const list = loadCheckins(); list.push(record); saveCheckins(list);
    state.picked = null; const cp=el('cardPicked'); if(cp) cp.classList.add('hidden');
    setText('doneTitle', t('attendanceConfirmed'));
    setText('doneSub', `${t('student')}: ${record.name} (${record.classId} #${record.number}) • ${t('group')}: ${record.group==='odd'?t('odd'):t('even')}`);
    setText('doneVenue', record.venue);
    const cd=el('cardDone'); if(cd) cd.classList.remove('hidden');
  }

  function refreshAdmin(){
    cloudList().then(function(resp){
      var list = (resp && resp.items) ? resp.items : loadCheckins();
      const q = (el('adminSearch')&&el('adminSearch').value||'').toLowerCase();
      list = list.filter(r=>!q || [r.name,r.classId,String(r.number),r.venue,r.group].some(v=>String(v).toLowerCase().includes(q)));
      const totalParents = list.reduce((a,r)=>a+(Number(r.parents)||0),0);
      setText('totalParents', String(totalParents));
      setText('totalFamilies', String(list.length));
      const root = el('adminList'); if(root){
        root.innerHTML='';
        list.forEach(r=>{
          const item = document.createElement('div'); item.className='item card';
          item.innerHTML = `<div class="content row" style="justify-content:space-between;align-items:center;gap:12px">
            <div>
              <div style="font-weight:600">${r.name} (${r.classId} #${r.number})</div>
              <div class="muted" style="font-size:12px">${(r.timestamp_iso||new Date(r.ts||Date.now()).toLocaleString())} • ${r.group} • ${r.venue}</div>
            </div>
            <div class="big">×${r.parents}</div>
          </div>`;
          root.appendChild(item);
        });
      }
    });
  } (${r.classId} #${r.number})</div>
            <div class="muted" style="font-size:12px">${new Date(r.ts).toLocaleString()} • ${r.group} • ${r.venue}</div>
          </div>
          <div class="big">×${r.parents}</div>
        </div>`;
        root.appendChild(item);
      });
    }
  }

  function exportCSV(){
    const rows = loadCheckins();
    const headers = ["timestamp_iso","class","number","name","group","venue","parents","lang"];
    const lines = [headers.join(",")];
    rows.forEach(r=>{
      const iso = new Date(r.ts).toISOString();
      const values = [iso,r.classId,r.number,r.name,r.group,r.venue,r.parents,r.lang].map(v=>`"${String(v).replace(/\"/g,'""')}"`);
      lines.push(values.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download='f1_checkins_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ====== Event bindings
  window.addEventListener('DOMContentLoaded', () => {
    // language buttons
    const btnEn = el('btnEn'); if(btnEn) btnEn.addEventListener('click',()=>setLang('en'));
    const btnZh = el('btnZh'); if(btnZh) btnZh.addEventListener('click',()=>setLang('zh'));

    // top-right
    const btnAdmin = el('btnAdmin'); if(btnAdmin) btnAdmin.addEventListener('click',()=>{ show('Admin'); const pin=el('inputPIN'); if(pin) pin.value=''; });

    // flow mode toggles
    const modeNumber = el('modeNumber'); if(modeNumber) modeNumber.addEventListener('click',()=>{ const pn=el('panelNumber'), pm=el('panelName'); if(pn) pn.classList.remove('hidden'); if(pm) pm.classList.add('hidden'); modeNumber.classList.add('primary'); const mn=el('modeName'); if(mn){ mn.classList.remove('primary'); mn.classList.add('secondary'); } });
    const modeName = el('modeName'); if(modeName) modeName.addEventListener('click',()=>{ const pm=el('panelName'), pn=el('panelNumber'); if(pm) pm.classList.remove('hidden'); if(pn) pn.classList.add('hidden'); modeName.classList.add('primary'); const mnum=el('modeNumber'); if(mnum){ mnum.classList.remove('primary'); mnum.classList.add('secondary'); } });

    // number confirmation
    const btnConfirmByNo = el('btnConfirmByNo'); if(btnConfirmByNo) btnConfirmByNo.addEventListener('click',()=>{
      const sel = el('selectClass'); const cls = sel? sel.value : ''; const num = el('inputNumber'); const n = Number(num? num.value : 0);
      if(!cls||!n||!state.roster){ alert(t('noMatch')); return; }
      const res = findByNumber(cls, n); if(res){ state.picked = res; const cd=el('cardDone'); if(cd) cd.classList.add('hidden'); updatePickedCard(); } else { alert(t('noMatch')); }
    });

    // name dropdown selection
    const selectStudent = el('selectStudent'); if(selectStudent) selectStudent.addEventListener('change',()=>{
      const sel = el('selectClass'); const cls = sel? sel.value : '';
      const val = selectStudent.value;
      if(!cls || !val || !state.roster){ return; }
      const n = Number(val);
      const res = findByNumber(cls, n);
      if(res){ state.picked = res; const cd=el('cardDone'); if(cd) cd.classList.add('hidden'); updatePickedCard(); }
    });

    const btnConfirmAttendance = el('btnConfirmAttendance'); if(btnConfirmAttendance) btnConfirmAttendance.addEventListener('click', confirmAttendance);
    const btnBack = el('btnBack'); if(btnBack) btnBack.addEventListener('click',()=>{ state.picked=null; const cp=el('cardPicked'); if(cp) cp.classList.add('hidden'); });
    const btnDoneBack = el('btnDoneBack'); if(btnDoneBack) btnDoneBack.addEventListener('click',()=>{ const cd=el('cardDone'); if(cd) cd.classList.add('hidden'); });
    const btnDoneReset = el('btnDoneReset'); if(btnDoneReset) btnDoneReset.addEventListener('click',()=>{ const cd=el('cardDone'); if(cd) cd.classList.add('hidden'); const sc=el('selectClass'); if(sc) sc.value=''; const inn=el('inputNumber'); if(inn) inn.value=''; const ss=el('selectStudent'); if(ss) ss.value=''; });

    // admin
    const btnUnlock = el('btnUnlock'); if(btnUnlock) btnUnlock.addEventListener('click',()=>{ const pin=el('inputPIN'); if(pin && pin.value===ADMIN_PIN){ show('AdminOpen'); refreshAdmin(); } });
    const btnAdminBack = el('btnAdminBack'); if(btnAdminBack) btnAdminBack.addEventListener('click',()=> show('Flow'));
    const btnLock = el('btnLock'); if(btnLock) btnLock.addEventListener('click',()=> show('Home'));
    const adminSearch = el('adminSearch'); if(adminSearch) adminSearch.addEventListener('input', refreshAdmin);
    const btnExport = el('btnExport'); if(btnExport) btnExport.addEventListener('click', exportCSV);

    // dropdown change clears panels & repopulates students
    const selectClass = el('selectClass'); if(selectClass) selectClass.addEventListener('change',()=>{
      const inn=el('inputNumber'); if(inn) inn.value='';
      const ss=el('selectStudent'); if(ss) ss.value='';
      state.picked=null; const cp=el('cardPicked'); if(cp) cp.classList.add('hidden'); const cd=el('cardDone'); if(cd) cd.classList.add('hidden');
      populateStudentsUI();
    });

    // init from storage
    try{ const r = JSON.parse(localStorage.getItem('f1.roster')||'null'); if(r) state.roster=r; }catch{}
    renderAll(); show('Flow'); cloudBanner();
    // show loading indicator
    setText('rosterStatus', 'Loading roster.xlsx…');
    (async () => {
      await tryAutoLoad();
      if(state.roster){ setText('rosterStatus', t('loadSuccess')); }
      else { setText('rosterStatus', t('loadFail')); }
    })();

    // ====== Lightweight self-tests (console only) ======
    try {
      // Original tests
      const sampleRows = [
        { class:'1B', number:1, en_name:'A EN', ch_name:'甲甲', group:'Odd',  venue:'M42(4/F)', parents_expected:2 },
        { class:'1B', number:2, en_name:'B EN', ch_name:'乙乙', group:'Even', venue:'M43(4/F)', parents_expected:1 },
      ];
      const data = buildData(sampleRows);
      console.assert(data.classes['1B'].odd.students.length===1, 'odd count');
      console.assert(data.classes['1B'].even.students.length===1, 'even count');
      const prevRoster = state.roster; state.roster = data;
      // Dropdown should populate with 2 students + 1 placeholder
      renderAll(); const selClass = el('selectClass'); if(selClass){ selClass.value='1B'; }
      populateStudentsUI(); const ss = el('selectStudent'); console.assert(ss && ss.options.length===3, 'dropdown options count (2 + placeholder)');
      // Number lookup and prefill
      console.assert(findByNumber('1B',2)?.label.includes('B EN'), 'findByNumber uses EN when present');
      // Expected parents prefill path
      state.picked = findByNumber('1B',1); updatePickedCard(); (function(){ const ip=el('inputParents'); if(ip){ console.assert(ip.value==='2', 'prefill parents_expected=2'); }})();
      // Clamp test: expected_parents > 4 clamps to 4
      state.roster = buildData([{ class:'1B', number:3, en_name:'C EN', ch_name:'丙丙', group:'Odd', venue:'M44', parents_expected:900 }]);
      state.picked = findByNumber('1B',3); updatePickedCard();
      (function(){ const ip=el('inputParents'); if(ip){ console.assert(ip.value==='4', 'prefill parents_expected>4 clamps to 4'); }})();
      // Restore sample data for following tests
      state.roster = data;
      // Suggestions API (still present) - English & Traditional
      console.assert(suggestionsFor('1B','A').length===1, 'suggestionsFor English');
      console.assert(suggestionsFor('1B','甲').length===1, 'suggestionsFor Traditional');
      const prevCheck = loadCheckins();
      saveCheckins([]);
      console.assert(hasCheckedIn('1B',1)===false, 'hasCheckedIn pre');
      saveCheckins([{ ts:Date.now(), classId:'1B', number:1, name:'甲甲 / A EN', group:'odd', venue:'M42(4/F)', parents:2, lang:'en' }]);
      console.assert(hasCheckedIn('1B',1)===true, 'hasCheckedIn true');
      console.assert(hasCheckedIn('1B',2)===false, 'hasCheckedIn other false');
      console.assert(setText('_missing_', 'x')===false, 'setText missing element');
      // Start disabled state when no roster
      state.roster = null; updateStartAvailability(); const startBtn = el('btnStart'); console.assert(startBtn ? startBtn.disabled===true : true, 'start disabled without roster');
      // CJK t<->s variant tests (only if OpenCC available)
      if (window.OpenCC && typeof OpenCC.Converter === 'function') {
        const cjkRows = [ { class:'1G', number:3, en_name:'Zhang San', ch_name:'张三', group:'Odd',  venue:'G11' }, ];
        state.roster = buildData(cjkRows);
        console.assert(suggestionsFor('1G','張').length>=1, 'CJK Traditional query matches Simplified name');
      }
      // restore
      state.roster = prevRoster; updateStartAvailability();
      saveCheckins(prevCheck);
      console.log('[Self-tests] passed');
    } catch(e) { console.warn('[Self-tests] failed', e); }
  });
  </script>
</body>
</html>
