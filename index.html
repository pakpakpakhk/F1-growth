<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F1 Growth Celebration – Self Check-in</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --primary:#2563eb; --ring:#93c5fd; --danger:#b91c1c; --danger-bg:#fee2e2; --danger-br:#fecaca;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(#fff,#f8fafc);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:#ffffffd9;backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:860px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 18px rgba(15,23,42,.06)}
    .card .content{padding:18px}
    h1{font-size:20px;margin:0;font-weight:700}
    h2{font-size:18px;margin:0 0 8px 0}
    p{margin:0 0 8px 0;color:var(--muted)}
    button{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    button.secondary{background:#f1f5f9}
    button:focus{outline:3px solid var(--ring);outline-offset:2px}
    button[disabled]{opacity:.6;cursor:not-allowed}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    input:focus,select:focus{outline:3px solid var(--ring);border-color:var(--primary)}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .big{font-size:26px;font-weight:800}
    .xl{font-size:22px;font-weight:700}
    .lang-toggle button{padding:8px 10px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
    .chip.danger{background:var(--danger-bg);border-color:var(--danger-br);color:var(--danger)}
    .foot{padding:28px;text-align:center;color:var(--muted);font-size:12px}
    @media (min-width:700px){ .two{grid-template-columns:1fr 1fr} }
  </style>
  <!-- Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Traditional/Simplified conversion (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
</head>
<body>
  <header>
    <div class="container row" style="align-items:center;justify-content:space-between;">
      <div class="row" style="align-items:center;gap:10px">
        <h1 id="title">F1 Growth Celebration Ceremony</h1>
        <span class="pill" id="datePill">25/10/2025</span>
      </div>
      <div class="row lang-toggle">
        <span class="muted" id="langLabel">Language</span>
        <button id="btnEn" class="secondary">English</button>
        <button id="btnZh" class="secondary">中文</button>
        <button id="btnAdmin" class="primary">Staff</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:16px;">
    <!-- Check-in page (shown immediately; no Start button) -->
    <section id="pageFlow">
      <div class="card"><div class="content grid">
        <div id="errorBanner" class="chip danger hidden"></div>
        <div id="rosterStatus" class="muted"></div>

        <div>
          <label id="labelSelectClass">Select Class</label>
          <select id="selectClass"><option value="" id="optChoose">Choose</option></select>
        </div>

        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button id="modeNumber" class="primary">Class No.</button>
          <button id="modeName" class="secondary">Choose from list</button>
        </div>

        <div id="panelNumber" class="grid">
          <label id="labelEnterNo">Enter class number (e.g., 12)</label>
          <input id="inputNumber" inputmode="numeric" pattern="[0-9]*" placeholder="12" />
          <button id="btnConfirmByNo" class="primary">Confirm student</button>
        </div>

        <div id="panelName" class="grid hidden">
          <label id="labelStudentName">Student name</label>
          <select id="selectStudent"><option value="" id="optStudentChoose">Choose a student</option></select>
        </div>
      </div></div>
    </section>

    <div id="cardPicked" class="card hidden"><div class="content grid">
      <div class="xl" id="pickedLine">Student: –</div>
      <div class="muted" id="pickedGroup">Group: –</div>
      <div class="muted">Venue: <span id="pickedVenue" style="font-weight:700"></span></div>
      <div id="alreadyWarn" class="chip danger hidden"></div>
      <div>
        <label id="labelParents">No. of parents attending</label>
        <input id="inputParents" inputmode="numeric" pattern="[0-9]*" value="1" />
      </div>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="btnConfirmAttendance" class="primary">Confirm attendance</button>
        <button id="btnBack" class="secondary">Back</button>
      </div>
    </div></div>

    <div id="cardDone" class="card hidden"><div class="content grid">
      <div class="xl" id="doneTitle">Attendance confirmed</div>
      <div class="muted" id="doneSub">Student: –</div>
      <div class="muted" id="donePrompt">After the briefing, please proceed to your designated room:</div>
      <div class="big" id="doneVenue">M42</div>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="btnDoneBack" class="primary">Back</button>
        <button id="btnDoneReset" class="secondary">Reset</button>
      </div>
    </div></div>

    <!-- Staff (lock) -->
    <section id="pageAdmin" class="hidden">
      <div class="card"><div class="content grid">
        <h2 id="adminTitle">Staff mode</h2>
        <label id="labelPIN">Enter PIN</label>
        <input id="inputPIN" inputmode="numeric" />
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <button id="btnUnlock" class="primary">Unlock</button>
          <button id="btnAdminBack" class="secondary">Back</button>
        </div>
      </div></div>
    </section>

    <!-- Staff (unlocked) -->
    <section id="pageAdminOpen" class="hidden">
      <div class="card"><div class="content grid">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="xl" id="adminOpenTitle">Staff mode</div>
          <div class="row" style="gap:10px;flex-wrap:wrap">
            <button id="btnExport" class="primary">Export CSV</button>
            <button id="btnLock" class="secondary">Lock</button>
          </div>
        </div>
        <div class="two grid">
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalParents">Total parents checked-in</div>
            <div class="big" id="totalParents">0</div>
          </div></div>
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalFamilies">Total families checked-in</div>
            <div class="big" id="totalFamilies">0</div>
          </div></div>
        </div>
        <input id="adminSearch" placeholder="Search…" />
        <div class="grid" id="adminList"></div>
      </div></div>
    </section>

    <div class="foot">© 2025 F1 Growth Celebration</div>
  </main>

  <script>
  // ===== Global error banner so Safari issues show on page =====
  (function(){
    var shown = false;
    function show(err){
      try{
        var n = document.getElementById('errorBanner');
        if(n && !shown){
          n.textContent = 'Error: ' + String(err);
          n.classList.remove('hidden');
          shown = true;
        }
      }catch(_){}
    }
    window.addEventListener('error', function(e){ show(e.message||e.error||'unknown'); });
    window.addEventListener('unhandledrejection', function(e){ show((e && e.reason) ? e.reason : 'Promise rejected'); });
  })();

  // ===== Config / i18n =====
  var ADMIN_PIN = "1025";
  var I18N = {
    en:{ appTitle:"F1 Growth Celebration Ceremony", language:"Language", staff:"Staff",
      selectClass:"Select Class", choose:"Choose", chooseStudent:"Choose a student",
      classNo:"Class No.", searchByName:"Choose from list", enterNumber:"Enter class number (e.g., 12)",
      studentName:"Student name", noMatch:"No matching student", confirmStudent:"Confirm student",
      student:"Student", group:"Group", odd:"Odd", even:"Even",
      parentsAttending:"No. of parents attending", confirmAttendance:"Confirm attendance",
      attendanceConfirmed:"Attendance confirmed", proceedToVenue:"After the briefing, please proceed to your designated room:",
      back:"Back", reset:"Reset", admin:"Staff mode", adminPIN:"Enter PIN", unlock:"Unlock", lock:"Lock",
      exportCSV:"Export CSV", totalParents:"Total parents checked-in", totalFamilies:"Total families checked-in",
      loadFail:"Could not load roster.xlsx in this folder.", loadSuccess:"Roster loaded. You may check in now.",
      alreadyCheckedIn:"Already checked in"
    },
    zh:{ appTitle:"中一成長祝福禮", language:"語言", staff:"職員",
      selectClass:"選擇班別", choose:"請選擇", chooseStudent:"請選擇學生",
      classNo:"學號", searchByName:"從名單選擇", enterNumber:"輸入學號（例如：12）",
      studentName:"學生姓名", noMatch:"找不到相符學生", confirmStudent:"確認學生",
      student:"學生", group:"組別", odd:"單號", even:"雙號",
      parentsAttending:"到場家長人數", confirmAttendance:"確認出席",
      attendanceConfirmed:"已完成簽到", proceedToVenue:"簡介會結束後，請前往指定課室：",
      back:"返回", reset:"重設", admin:"職員模式", adminPIN:"輸入密碼", unlock:"解鎖", lock:"上鎖",
      exportCSV:"匯出 CSV", totalParents:"已簽到家長總數", totalFamilies:"已簽到家庭數",
      loadFail:"未能載入 roster.xlsx。", loadSuccess:"已載入名單，可開始簽到。", alreadyCheckedIn:"已簽到"
    }
  };
  var state = { lang: (localStorage.getItem('f1.lang')||'en'), roster:null, picked:null };
  function t(k){ return I18N[state.lang][k]; }
  function el(id){ return document.getElementById(id); }
  function setText(id, txt){ var n=el(id); if(n){ n.textContent=txt; } }

  // ===== Storage =====
  function loadCheckins(){ try{ return JSON.parse(localStorage.getItem('f1.checkins')||'[]'); }catch(e){ return []; } }
  function saveCheckins(list){ localStorage.setItem('f1.checkins', JSON.stringify(list)); }
  function hasCheckedIn(cid, num){ var list=loadCheckins(); for(var i=0;i<list.length;i++){ var r=list[i]; if(r.classId===cid && Number(r.number)===Number(num)) return true; } return false; }

  // ===== OpenCC (optional) =====
  var _convT2S=null,_convS2T=null;
  try{ if(window.OpenCC && typeof OpenCC.Converter==='function'){ _convT2S=OpenCC.Converter({from:'tw',to:'cn'}); _convS2T=OpenCC.Converter({from:'cn',to:'tw'}); } }catch(e){}

  // ===== Name label & Safari-safe option =====
  function stripZW(s){ return String(s||'').replace(/[\u200B\u200C\u200D\uFEFF]/g,''); }
  function displayLabel(stu){
    var ch = stripZW(stu.ch_name||'').trim();
    var en = stripZW(stu.en_name||'').trim();
    return (ch && en) ? (ch+' / '+en) : (ch || en || '');
  }

  // ===== Build roster (NBSP/space/underscore/case tolerant) =====
  function normalizeRow(r){
    var NBSP = String.fromCharCode(160);
    function normKey(k){ return String(k||'').toLowerCase().split(NBSP).join(' ').replace(/[\s_]+/g,'').trim(); }
    function pickAny(obj, keys){
      var map={},k; for(k in obj){ if(Object.prototype.hasOwnProperty.call(obj,k)) map[normKey(k)]=k; }
      for(var i=0;i<keys.length;i++){ var want = normKey(keys[i]); if(map[want]!=null) return obj[map[want]]; }
      return undefined;
    }
    function toStr(v){ return String(v==null?'':v).split(NBSP).join(' ').trim(); }

    var cls = toStr(pickAny(r, ['class','Class','CLASS']));
    var number = Number(pickAny(r, ['number','Number','no','No','NO','class_no','classno'])||0);
    var en = toStr(pickAny(r, ['en_name','enName','EN_NAME','english','English','english_name','englishname','name_en','student_english','studentenglish','English Name','EnglishName']));
    var ch = toStr(pickAny(r, ['ch_name','chName','CH_NAME','chinese','Chinese','chinesename','chinese_name','name_ch','chi_name','student_chinese','studentchinese','中文姓名','CH Name','CHName']));
    var grpRaw = String(toStr(pickAny(r,['group','Group']))).toLowerCase();
    var group = grpRaw.indexOf('odd')>=0 ? 'odd' : (grpRaw.indexOf('even')>=0 ? 'even' : (number%2? 'odd':'even'));
    var venue = toStr(pickAny(r, ['venue','Venue','room','Room','classroom']));
    var parents = Number(pickAny(r, ['parents_expected','expected_parents','parents','no_of_parents','parents_coming','parent_count','ParentCount','Parents','Expected Parents'])||0);

    return { cls:cls, number:number, en_name:en, ch_name:ch, group:group, venue:venue, parents_expected:(parents>0?parents:0) };
  }
  function buildData(rows){
    var data = { classes:{} };
    for(var i=0;i<rows.length;i++){
      var row = normalizeRow(rows[i]);
      if(!row.cls || !row.number) continue;
      if(!data.classes[row.cls]) data.classes[row.cls]={ odd:{venue:null,students:[]}, even:{venue:null,students:[]} };
      var bucket = data.classes[row.cls][row.group];
      if(!bucket.venue && row.venue) bucket.venue=row.venue;
      var disp = displayLabel({en_name:row.en_name, ch_name:row.ch_name}) || ('#'+row.number);
      bucket.students.push({ number:row.number, en_name:row.en_name, ch_name:row.ch_name, display_name:disp, expected_parents:(row.parents_expected>0?row.parents_expected:null) });
    }
    // sort
    var ckey; for(ckey in data.classes){
      var cb = data.classes[ckey];
      cb.odd.students.sort(function(a,b){return a.number-b.number;});
      cb.even.students.sort(function(a,b){return a.number-b.number;});
    }
    return data;
  }

  // ===== XLSX load =====
  function parseExcelArrayBuffer(buf){
    var wb = XLSX.read(new Uint8Array(buf), { type:'array' });
    var ws = wb.Sheets['roster'] || wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error('No sheets found');
    var rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
    return buildData(rows);
  }
  function loadRosterFromUrl(url){
    return fetch(url, { cache:'no-store' }).then(function(res){
      if(!res.ok) throw new Error('HTTP '+res.status);
      if(/\.json($|\?)/i.test(url)) return res.json();
      return res.arrayBuffer().then(parseExcelArrayBuffer);
    });
  }

  // ===== UI population =====
  function fillClassSelect(){
    var sel = el('selectClass'); if(!sel) return;
    var keep = sel.value;
    sel.innerHTML = '<option value="" id="optChoose">'+t('choose')+'</option>';
    if(state.roster){
      var keys = Object.keys(state.roster.classes).sort();
      for(var i=0;i<keys.length;i++){
        var c = keys[i];
        var opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);
      }
      if(keep && state.roster.classes[keep]) sel.value=keep;
      populateStudentsUI();
    }
  }
  function populateStudentsUI(){
    var clsSel = el('selectClass'); var cls = clsSel ? clsSel.value : '';
    var sel = el('selectStudent'); if(!sel) return;
    sel.innerHTML = '<option value="" id="optStudentChoose">'+t('chooseStudent')+'</option>';
    if(!state.roster || !cls || !state.roster.classes[cls]) return;
    var cb = state.roster.classes[cls];

    function makeOption(s, group, venue){
      var opt = document.createElement('option');
      opt.value = String(s.number);
      var name = displayLabel(s);
      var labelCore = name || ('#'+s.number);
      var grpText = group==='odd'?t('odd'):t('even');
      var text = labelCore+' (#'+s.number+' • '+grpText+')'+(hasCheckedIn(cls, s.number)?' ✓':'');
      // iOS/Safari: visible text comes from .label in the native picker
      opt.label = text;
      // Also append an actual text node for other engines
      opt.appendChild(document.createTextNode(text));
      opt.dataset.group = group;
      opt.dataset.venue = venue || '';
      opt.dataset.expected = (s.expected_parents!=null) ? String(s.expected_parents) : '';
      return opt;
    }
    var i;
    for(i=0;i<cb.odd.students.length;i++) sel.appendChild(makeOption(cb.odd.students[i],'odd', cb.odd.venue));
    for(i=0;i<cb.even.students.length;i++) sel.appendChild(makeOption(cb.even.students[i],'even', cb.even.venue));
  }

  function findByNumber(cls, n){
    var cb = state.roster.classes[cls]; if(!cb) return null;
    var i,s;
    for(i=0;i<cb.odd.students.length;i++){ s=cb.odd.students[i]; if(s.number===n) return { classId:cls, number:n, label: displayLabel(s)||s.display_name, group:'odd', venue: cb.odd.venue||'', expected_parents:s.expected_parents }; }
    for(i=0;i<cb.even.students.length;i++){ s=cb.even.students[i]; if(s.number===n) return { classId:cls, number:n, label: displayLabel(s)||s.display_name, group:'even', venue: cb.even.venue||'', expected_parents:s.expected_parents }; }
    return null;
  }

  function updatePickedCard(){
    var c = state.picked; if(!c){ el('cardPicked').classList.add('hidden'); return; }
    setText('pickedLine', t('student')+': '+c.label+' ('+c.classId+' #'+c.number+')');
    setText('pickedGroup', t('group')+': '+(c.group==='odd'?t('odd'):t('even')));
    setText('pickedVenue', c.venue||'');
    var exists = hasCheckedIn(c.classId, c.number);
    var warn = el('alreadyWarn'); var btn = el('btnConfirmAttendance'); var ip = el('inputParents');
    if(exists){ if(warn){ warn.textContent = t('alreadyCheckedIn'); warn.classList.remove('hidden'); } if(btn) btn.disabled=true; }
    else { if(warn) warn.classList.add('hidden'); if(btn) btn.disabled=false; if(ip) ip.value = (c.expected_parents && Number(c.expected_parents)>0) ? String(c.expected_parents) : '1'; }
    el('cardPicked').classList.remove('hidden');
  }

  function confirmAttendance(){
    var p = Math.max(1, Number((el('inputParents')&&el('inputParents').value)||1));
    var c = state.picked; if(!c) return;
    if(hasCheckedIn(c.classId, c.number)){
      setText('doneTitle', t('alreadyCheckedIn'));
      setText('doneSub', t('student')+': '+c.label+' ('+c.classId+' #'+c.number+') • '+t('group')+': '+(c.group==='odd'?t('odd'):t('even')));
      setText('doneVenue', c.venue);
      el('cardPicked').classList.add('hidden'); el('cardDone').classList.remove('hidden');
      return;
    }
    var list = loadCheckins();
    list.push({ ts:Date.now(), classId:c.classId, number:c.number, name:c.label, group:c.group, venue:c.venue, parents:p, lang:state.lang });
    saveCheckins(list);
    setText('doneTitle', t('attendanceConfirmed'));
    setText('doneSub', t('student')+': '+c.label+' ('+c.classId+' #'+c.number+') • '+t('group')+': '+(c.group==='odd'?t('odd'):t('even')));
    setText('doneVenue', c.venue);
    el('cardPicked').classList.add('hidden'); el('cardDone').classList.remove('hidden');
    state.picked = null;
  }

  function refreshAdmin(){
    var q = (el('adminSearch')&&el('adminSearch').value||'').toLowerCase();
    var list = loadCheckins().filter(function(r){
      return !q || (String(r.name).toLowerCase().indexOf(q)>=0 || String(r.classId).toLowerCase().indexOf(q)>=0 || String(r.number).toLowerCase().indexOf(q)>=0 || String(r.venue).toLowerCase().indexOf(q)>=0 || String(r.group).toLowerCase().indexOf(q)>=0);
    });
    var totalParents = 0; for(var i=0;i<list.length;i++) totalParents += (Number(list[i].parents)||0);
    setText('totalParents', String(totalParents));
    setText('totalFamilies', String(list.length));
    var root = el('adminList'); if(root){ root.innerHTML=''; for(var j=0;j<list.length;j++){ var r=list[j]; var item=document.createElement('div'); item.className='card'; item.innerHTML='<div class="content"><div style="font-weight:600">'+r.name+' ('+r.classId+' #'+r.number+')</div><div class="muted" style="font-size:12px">'+(new Date(r.ts).toLocaleString())+' • '+r.group+' • '+r.venue+'</div><div class="big">×'+r.parents+'</div></div>'; root.appendChild(item);} }
  }

  function exportCSV(){
    var rows = loadCheckins(), headers = ["timestamp_iso","class","number","name","group","venue","parents","lang"], lines=[headers.join(",")];
    for(var i=0;i<rows.length;i++){ var r=rows[i]; var iso=new Date(r.ts).toISOString(); var vals=[iso,r.classId,r.number,r.name,r.group,r.venue,r.parents,r.lang].map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}); lines.push(vals.join(',')); }
    var blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob), a=document.createElement('a'); a.href=url; a.download='f1_checkins_'+new Date().toISOString().slice(0,10)+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function updateRosterStatus(){ setText('rosterStatus', state.roster ? t('loadSuccess') : t('loadFail')); }

  function tryAutoLoad(){
    if(state.roster){ fillClassSelect(); updateRosterStatus(); return; }
    var params = new URLSearchParams(location.search);
    var rosterParam = params.get('roster')||params.get('xls')||params.get('excel');
    var candidates = []; if(rosterParam) candidates.push(rosterParam); candidates.push('./roster.xlsx');
    (function seq(i){
      if(i>=candidates.length){ updateRosterStatus(); return; }
      loadRosterFromUrl(candidates[i]).then(function(data){ state.roster=data; localStorage.setItem('f1.roster', JSON.stringify(data)); fillClassSelect(); updateRosterStatus(); }).catch(function(){ seq(i+1); });
    })(0);
  }

  // ===== Boot & bindings =====
  window.addEventListener('DOMContentLoaded', function(){
    // i18n
    setText('title', t('appTitle')); setText('langLabel', t('language')); setText('btnAdmin', t('staff'));
    setText('labelSelectClass', t('selectClass')); setText('optChoose', t('choose'));
    setText('modeNumber', t('classNo')); setText('modeName', t('searchByName'));
    setText('labelEnterNo', t('enterNumber')); setText('btnConfirmByNo', t('confirmStudent'));
    setText('labelStudentName', t('studentName')); setText('labelParents', t('parentsAttending'));
    setText('btnConfirmAttendance', t('confirmAttendance')); setText('btnBack', t('back'));
    setText('doneTitle', t('attendanceConfirmed')); setText('donePrompt', t('proceedToVenue'));
    setText('btnDoneBack', t('back')); setText('btnDoneReset', t('reset'));
    setText('adminTitle', t('admin')); setText('labelPIN', t('adminPIN')); setText('btnUnlock', t('unlock'));
    setText('btnAdminBack', t('back')); setText('adminOpenTitle', t('admin')); setText('btnExport', t('exportCSV'));
    setText('btnLock', t('lock')); setText('labelTotalParents', t('totalParents')); setText('labelTotalFamilies', t('totalFamilies'));
    setText('optStudentChoose', t('chooseStudent'));

    // language switches
    var btnEn=el('btnEn'); if(btnEn) btnEn.addEventListener('click', function(){ state.lang='en'; localStorage.setItem('f1.lang','en'); window.location.reload(); });
    var btnZh=el('btnZh'); if(btnZh) btnZh.addEventListener('click', function(){ state.lang='zh'; localStorage.setItem('f1.lang','zh'); window.location.reload(); });

    // admin buttons
    var btnAdmin=el('btnAdmin'); if(btnAdmin) btnAdmin.addEventListener('click', function(){ el('pageAdmin').classList.remove('hidden'); });
    var btnAdminBack=el('btnAdminBack'); if(btnAdminBack) btnAdminBack.addEventListener('click', function(){ el('pageAdmin').classList.add('hidden'); });
    var btnUnlock=el('btnUnlock'); if(btnUnlock) btnUnlock.addEventListener('click', function(){ if(el('inputPIN').value===ADMIN_PIN){ el('pageAdmin').classList.add('hidden'); el('pageAdminOpen').classList.remove('hidden'); refreshAdmin(); } });
    var btnLock=el('btnLock'); if(btnLock) btnLock.addEventListener('click', function(){ el('pageAdminOpen').classList.add('hidden'); });

    // mode toggles
    var modeNumber=el('modeNumber'), modeName=el('modeName');
    if(modeNumber) modeNumber.addEventListener('click', function(){ el('panelNumber').classList.remove('hidden'); el('panelName').classList.add('hidden'); modeNumber.classList.add('primary'); modeName.classList.remove('primary'); modeName.classList.add('secondary'); });
    if(modeName) modeName.addEventListener('click', function(){ el('panelName').classList.remove('hidden'); el('panelNumber').classList.add('hidden'); modeName.classList.add('primary'); modeNumber.classList.remove('primary'); modeNumber.classList.add('secondary'); });

    // confirm by number
    var btnConfirmByNo=el('btnConfirmByNo'); if(btnConfirmByNo) btnConfirmByNo.addEventListener('click', function(){
      var cls = el('selectClass').value; var n = Number(el('inputNumber').value||0);
      if(!cls || !n || !state.roster){ alert(t('noMatch')); return; }
      var res = findByNumber(cls, n);
      if(res){ state.picked=res; el('cardDone').classList.add('hidden'); updatePickedCard(); } else { alert(t('noMatch')); }
    });

    // dropdown by name
    var selectStudent=el('selectStudent'); if(selectStudent) selectStudent.addEventListener('change', function(){
      var cls = el('selectClass').value; var val = selectStudent.value;
      if(!cls || !val || !state.roster) return;
      var res = findByNumber(cls, Number(val));
      if(res){ state.picked=res; el('cardDone').classList.add('hidden'); updatePickedCard(); }
    });

    // confirm / back
    var btnConfirmAttendance=el('btnConfirmAttendance'); if(btnConfirmAttendance) btnConfirmAttendance.addEventListener('click', confirmAttendance);
    var btnBack=el('btnBack'); if(btnBack) btnBack.addEventListener('click', function(){ state.picked=null; el('cardPicked').classList.add('hidden'); });
    var btnDoneBack=el('btnDoneBack'); if(btnDoneBack) btnDoneBack.addEventListener('click', function(){ el('cardDone').classList.add('hidden'); });
    var btnDoneReset=el('btnDoneReset'); if(btnDoneReset) btnDoneReset.addEventListener('click', function(){
      el('cardDone').classList.add('hidden'); el('selectClass').value=''; el('inputNumber').value=''; el('selectStudent').value='';
    });

    // class change
    var selectClass=el('selectClass'); if(selectClass) selectClass.addEventListener('change', function(){
      el('inputNumber').value=''; el('selectStudent').value=''; state.picked=null; el('cardPicked').classList.add('hidden'); el('cardDone').classList.add('hidden');
      populateStudentsUI();
    });

    // load cached roster if any
    try{ var cached = JSON.parse(localStorage.getItem('f1.roster')||'null'); if(cached) state.roster=cached; }catch(e){}
    fillClassSelect();
    setText('rosterStatus','Loading roster.xlsx…');
    tryAutoLoad();
  });
  </script>
</body>
</html>
