<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F1 Growth Celebration – Self Check‑in</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --primary:#2563eb; --primary-2:#1d4ed8; --ring:#93c5fd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(#fff,#f8fafc);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:#ffffffd9;backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:860px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .spacer{height:8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 18px rgba(15,23,42,.06)}
    .card .content{padding:18px}
    h1{font-size:20px;margin:0;font-weight:700}
    h2{font-size:18px;margin:0 0 8px 0}
    p{margin:0 0 8px 0;color:var(--muted)}
    button{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    button.primary:active{transform:translateY(1px)}
    button.secondary{background:#f1f5f9}
    button:focus{outline:3px solid var(--ring);outline-offset:2px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    input:focus,select:focus{outline:3px solid var(--ring);border-color:var(--primary)}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .toolbar{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:12px;border:1px solid #e0e7ff}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .list{display:grid;gap:8px}
    .list .item{display:flex;justify-content:space-between;align-items:center}
    .big{font-size:26px;font-weight:800}
    .xl{font-size:22px;font-weight:700}
    .lang-toggle button{padding:8px 10px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
    .center{display:flex;align-items:center;justify-content:center}
    .foot{padding:28px;text-align:center;color:var(--muted);font-size:12px}
    .suggest{display:grid;gap:8px}
    .suggest button{justify-content:flex-start}
    @media (min-width:700px){ .two{grid-template-columns:1fr 1fr} }
  </style>
  <!-- Excel library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div class="container row" style="align-items:center;justify-content:space-between;">
      <div class="row" style="align-items:center;gap:10px">
        <h1 id="title">F1 Growth Celebration Ceremony</h1>
        <span class="pill" id="datePill">25/10/2025</span>
      </div>
      <div class="row lang-toggle">
        <span class="muted" id="langLabel">Language</span>
        <button id="btnEn" class="secondary">English</button>
        <button id="btnZh" class="secondary">中文</button>
        <button id="btnAdmin" class="primary">Staff</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:16px;">
    <!-- HOME -->
    <section id="pageHome">
      <div class="card"><div class="content grid">
        <div class="xl" id="homeTitle">F1 Growth Celebration Ceremony</div>
        <p id="homeIntro">Please check in here when you arrive at the school hall to see your classroom meeting venue.</p>
        <div class="btns">
          <button class="primary" id="btnStart">Start</button>
        </div>
        <div id="rosterStatus" class="muted"></div>
      </div></div>
    </section>

    <!-- FLOW -->
    <section id="pageFlow" class="hidden">
      <div class="card"><div class="content grid">
        <div>
          <label id="labelSelectClass">Select Class</label>
          <select id="selectClass"><option value="" id="optChoose">Choose</option></select>
        </div>
        <div class="btns">
          <button id="modeNumber" class="primary">Class No.</button>
          <button id="modeName" class="secondary">Search by Student Name</button>
        </div>
        <div id="panelNumber" class="grid">
          <label id="labelEnterNo">Enter class number (e.g., 12)</label>
          <input id="inputNumber" inputmode="numeric" pattern="[0-9]*" placeholder="12" />
          <button id="btnConfirmByNo" class="primary">Confirm student</button>
        </div>
        <div id="panelName" class="grid hidden">
          <label id="labelStudentName">Student name</label>
          <input id="inputName" placeholder="e.g., CHEN" />
          <div id="suggestions" class="suggest"></div>
        </div>
      </div></div>

      <div id="cardPicked" class="card hidden"><div class="content grid">
        <div class="xl" id="pickedLine">Student: –</div>
        <div class="muted" id="pickedGroup">Group: –</div>
        <div class="muted">Venue: <span id="pickedVenue" style="font-weight:700"></span></div>
        <div id="alreadyWarn" class="chip hidden" style="background:#fee2e2;border-color:#fecaca;color:#7f1d1d"></div>
        <div>
          <label id="labelParents">No. of parents attending</label>
          <input id="inputParents" inputmode="numeric" pattern="[0-9]*" value="1" />
        </div>
        <div class="btns">
          <button id="btnConfirmAttendance" class="primary">Confirm attendance</button>
          <button id="btnBack" class="secondary">Back</button>
        </div>
      </div></div>

      <div id="cardDone" class="card hidden"><div class="content grid">
        <div class="xl" id="doneTitle">Attendance confirmed</div>
        <div class="muted" id="doneSub">Student: –</div>
        <div class="muted" id="donePrompt">Please proceed to your meeting venue:</div>
        <div class="big" id="doneVenue">M42</div>
        <div class="btns">
          <button id="btnDoneBack" class="primary">Back</button>
          <button id="btnDoneReset" class="secondary">Reset</button>
        </div>
      </div></div>
    </section>

    <!-- ADMIN LOCK -->
    <section id="pageAdmin" class="hidden">
      <div class="card"><div class="content grid">
        <h2 id="adminTitle">Staff mode</h2>
        <label id="labelPIN">Enter PIN</label>
        <input id="inputPIN" inputmode="numeric" />
        <div class="btns">
          <button id="btnUnlock" class="primary">Unlock</button>
          <button id="btnAdminBack" class="secondary">Back</button>
        </div>
      </div></div>
    </section>

    <!-- ADMIN UNLOCKED -->
    <section id="pageAdminOpen" class="hidden">
      <div class="card"><div class="content grid">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="xl" id="adminOpenTitle">Staff mode</div>
          <div class="btns">
            <button id="btnExport" class="primary">Export CSV</button>
            <button id="btnLock" class="secondary">Lock</button>
          </div>
        </div>
        <div class="two grid">
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalParents">Total parents checked-in</div>
            <div class="big" id="totalParents">0</div>
          </div></div>
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalFamilies">Total families checked-in</div>
            <div class="big" id="totalFamilies">0</div>
          </div></div>
        </div>
        <input id="adminSearch" placeholder="Search…" />
        <div class="list" id="adminList"></div>
      </div></div>
    </section>

    <div class="foot">© 2025 F1 Growth Celebration</div>
  </main>

  <script>
  // ====== CONFIG ======
  const ADMIN_PIN = "1025"; // Change if desired

  // ====== I18N ======
  const I18N = {
    en: {
      appTitle: "F1 Growth Celebration Ceremony",
      intro1: "Please check in here when you arrive at the school hall to see your classroom meeting venue.",
      start: "Start",
      setup: "Setup",
      language: "Language",
      english: "English",
      chinese: "中文",
      selectClass: "Select Class",
      choose: "Choose",
      classNo: "Class No.",
      or: "or",
      searchByName: "Search by Student Name",
      enterNumber: "Enter class number (e.g., 12)",
      studentName: "Student name",
      noMatch: "No matching student",
      confirmStudent: "Confirm student",
      student: "Student",
      group: "Group",
      venue: "Meeting venue",
      odd: "Odd",
      even: "Even",
      parentsAttending: "No. of parents attending",
      confirmAttendance: "Confirm attendance",
      attendanceConfirmed: "Attendance confirmed",
      proceedToVenue: "Please proceed to your meeting venue:",
      back: "Back",
      reset: "Reset",
      admin: "Staff mode",
      adminPIN: "Enter PIN",
      unlock: "Unlock",
      lock: "Lock",
      exportCSV: "Export CSV",
      totalParents: "Total parents checked-in",
      totalFamilies: "Total families checked-in",
      loadRoster: "Upload roster (Excel)",
      loadJSON: "Upload JSON",
      loadSample: "Load sample data",
      setupTitle: "Setup: Load roster",
      setupDesc: "This app will try to auto‑load your roster from ./roster.xlsx (or use ?roster=<url>). You can also upload the Excel with a 'roster' sheet (columns: class, number, name, group, venue, display_name). Data is stored locally on this device only.",
      continue: "Continue",
      qrPoster: "QR poster",
      appLink: "App link",
      copy: "Copy",
      copied: "Copied!",
      changeLanguage: "Change language",
      staff: "Staff",
      alreadyCheckedIn: "Already checked in",
      duplicateMsg: "This student has already checked in. Showing venue again.",
    },
    zh: {
      appTitle: "中一 成長慶典",
      intro1: "到達禮堂時，請在此自行簽到，以查看活動教室地點。",
      start: "開始",
      setup: "設定",
      language: "語言",
      english: "English",
      chinese: "中文",
      selectClass: "選擇班別",
      choose: "請選擇",
      classNo: "學號",
      or: "或",
      searchByName: "以學生姓名搜尋",
      enterNumber: "輸入學號（例如：12）",
      studentName: "學生姓名",
      noMatch: "找不到相符學生",
      confirmStudent: "確認學生",
      student: "學生",
      group: "組別",
      venue: "集合地點",
      odd: "單號",
      even: "雙號",
      parentsAttending: "到場家長人數",
      confirmAttendance: "確認出席",
      attendanceConfirmed: "已完成簽到",
      proceedToVenue: "請前往以下集合地點：",
      back: "返回",
      reset: "重設",
      admin: "職員模式",
      adminPIN: "輸入密碼",
      unlock: "解鎖",
      lock: "上鎖",
      exportCSV: "匯出 CSV",
      totalParents: "已簽到家長總數",
      totalFamilies: "已簽到家庭數",
      loadRoster: "上載名單（Excel）",
      loadJSON: "上載 JSON",
      loadSample: "載入示例資料",
      setupTitle: "設定：載入名單",
      setupDesc: "本應用會嘗試自動載入 ./roster.xlsx（或使用網址參數 ?roster=<連結>）。亦可上載含「roster」工作表的 Excel（欄位：class, number, name, group, venue, display_name）。資料只儲存在本機裝置。",
      continue: "繼續",
      qrPoster: "二維碼海報",
      appLink: "應用連結",
      copy: "複製",
      copied: "已複製！",
      changeLanguage: "切換語言",
      staff: "職員",
      alreadyCheckedIn: "已簽到",
      duplicateMsg: "此學生已簽到，現再次顯示集合地點。",
    },
  };

  function t(key){ return I18N[state.lang][key]; }

  // ====== State & Storage ======
  const state = {
    lang: localStorage.getItem('f1.lang') || 'en',
    roster: null, // { classes: { '1B': { odd:{venue,students}, even:{...} } } }
    picked: null, // { classId, number, name, group, venue }
    checkins: [],
  };

  function loadCheckins(){ try{return JSON.parse(localStorage.getItem('f1.checkins')||'[]')}catch{return[]} }
  function saveCheckins(list){ localStorage.setItem('f1.checkins', JSON.stringify(list)); }
  function hasCheckedIn(classId, number){ return loadCheckins().some(r => r.classId===classId && Number(r.number)===Number(number)); }

  // ====== DOM ======
  const el = (id)=>document.getElementById(id);
  const pages = ['Home','Flow','Admin','AdminOpen'];
  function show(page){ pages.forEach(p=> el('page'+p).classList.toggle('hidden', p!==page) ); }

  // ====== Roster handling ======
  function normalizeRow(r){
    const cls = String(r.class||r.Class||'').trim();
    const number = Number(r.number||r.Number||0);
    const name = String(r.name||r.Name||'').trim();
    const display = String(r.display_name||r.displayName||`${name} (${cls} #${number})`).trim();
    const gRaw = String(r.group||r.Group||'').toLowerCase();
    const group = gRaw.includes('odd') ? 'odd' : gRaw.includes('even') ? 'even' : (number%2? 'odd':'even');
    const venue = String(r.venue||r.Venue||'').trim();
    return { cls, number, name, display, group, venue };
  }

  function buildData(rows){
    const data = { classes:{} };
    rows.forEach(row=>{
      const { cls, number, name, display, group, venue } = normalizeRow(row);
      if(!cls||!number||!name) return;
      if(!data.classes[cls]) data.classes[cls] = { odd:{venue:null,students:[]}, even:{venue:null,students:[]} };
      const bucket = data.classes[cls][group];
      if(!bucket.venue && venue) bucket.venue = venue;
      bucket.students.push({ number, name, display_name: display });
    });
    Object.values(data.classes).forEach(cb=>{
      cb.odd.students.sort((a,b)=>a.number-b.number);
      cb.even.students.sort((a,b)=>a.number-b.number);
    });
    return data;
  }

  async function parseExcelArrayBuffer(buf){
    const wb = XLSX.read(new Uint8Array(buf), { type:'array' });
    const ws = wb.Sheets['roster'] || wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error('No sheets found');
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
    return buildData(rows);
  }

  async function loadRosterFromUrl(url){
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    if(/\.json($|\?)/i.test(url)){
      const j = await res.json();
      return j;
    } else {
      const ab = await res.arrayBuffer();
      return await parseExcelArrayBuffer(ab);
    }
  }

  async function tryAutoLoad(){
    if(state.roster) return;
    const params = new URLSearchParams(location.search);
    const rosterParam = params.get('roster')||params.get('xls')||params.get('excel');
    const jsonParam = params.get('json');
    const candidates = [];
    if(rosterParam) candidates.push(rosterParam);
    if(jsonParam) candidates.push(jsonParam);
    candidates.push('./roster.xlsx','./F1%20growth%20ceremony.xlsx','./F1_growth_ceremony.xlsx');
    for(const u of candidates){
      try{
        const data = await loadRosterFromUrl(u);
        state.roster = data;
        localStorage.setItem('f1.roster', JSON.stringify(data));
        console.info('Roster auto-loaded from', u);
        break;
      }catch(e){ console.warn('Auto-load failed for', u, e); }
    }
    renderAll();
  }

  // ====== UI Logic
  function setLang(lang){ state.lang = lang; localStorage.setItem('f1.lang', lang); renderAll(); }

  function renderAll(){
    // header
    el('title').textContent = t('appTitle');
    el('homeTitle').textContent = t('appTitle');
    el('homeIntro').textContent = t('intro1');
    el('btnStart').textContent = t('start');
    el('langLabel').textContent = t('language');
    el('btnAdmin').textContent = t('staff');

    // flow labels
    el('labelSelectClass').textContent = t('selectClass');
    el('optChoose').textContent = t('choose');
    el('modeNumber').textContent = t('classNo');
    el('modeName').textContent = t('searchByName');
    el('labelEnterNo').textContent = t('enterNumber');
    el('btnConfirmByNo').textContent = t('confirmStudent');
    el('labelStudentName').textContent = t('studentName');
    el('labelParents').textContent = t('parentsAttending');
    el('btnConfirmAttendance').textContent = t('confirmAttendance');
    el('btnBack').textContent = t('back');

    // done card
    el('doneTitle').textContent = t('attendanceConfirmed');
    el('donePrompt').textContent = t('proceedToVenue');
    el('btnDoneBack').textContent = t('back');
    el('btnDoneReset').textContent = t('reset');

    // admin lock
    el('adminTitle').textContent = t('admin');
    el('labelPIN').textContent = t('adminPIN');
    el('btnUnlock').textContent = t('unlock');
    el('btnAdminBack').textContent = t('back');

    // admin open
    el('adminOpenTitle').textContent = t('admin');
    el('btnExport').textContent = t('exportCSV');
    el('btnLock').textContent = t('lock');
    el('labelTotalParents').textContent = t('totalParents');
    el('labelTotalFamilies').textContent = t('totalFamilies');

    // class list
    const sel = el('selectClass');
    const keep = sel.value;
    sel.innerHTML = `<option value="">${t('choose')}</option>`;
    if(state.roster){
      Object.keys(state.roster.classes).sort().forEach(c=>{
        const opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);
      });
      if(Object.keys(state.roster.classes).includes(keep)) sel.value = keep;
    }
  }

  function suggestionsFor(cls, query){
    if(!state.roster || !cls || !query) return [];
    const cb = state.roster.classes[cls]; if(!cb) return [];
    const list = [...cb.odd.students, ...cb.even.students];
    const q = query.toLowerCase();
    return list.filter(s=> (s.display_name||s.name).toLowerCase().includes(q)).slice(0,8);
  }

  function findByNumber(cls, n){
    const cb = state.roster.classes[cls]; if(!cb) return null;
    const sOdd = cb.odd.students.find(s=>s.number===n);
    if(sOdd) return { classId:cls, number:n, name:sOdd.name, group:'odd', venue: cb.odd.venue||'' };
    const sEven = cb.even.students.find(s=>s.number===n);
    if(sEven) return { classId:cls, number:n, name:sEven.name, group:'even', venue: cb.even.venue||'' };
    return null;
  }
  function findByName(cls, nameOrDisplay){
    const cb = state.roster.classes[cls]; if(!cb) return null;
    const all=[...cb.odd.students,...cb.even.students];
    const s = all.find(x=>x.name===nameOrDisplay || x.display_name===nameOrDisplay);
    if(!s) return null;
    const inOdd = cb.odd.students.some(st=>st.number===s.number);
    const group = inOdd? 'odd':'even';
    const venue = inOdd? (cb.odd.venue||'') : (cb.even.venue||'');
    return { classId:cls, number:s.number, name:s.name, group, venue };
  }

  function updatePickedCard(){
    const c = state.picked; if(!c){ el('cardPicked').classList.add('hidden'); return; }
    el('pickedLine').textContent = `${t('student')}: ${c.name} (${c.classId} #${c.number})`;
    el('pickedGroup').textContent = `${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`;
    el('pickedVenue').textContent = c.venue||'';
    const exists = hasCheckedIn(c.classId, c.number);
    const warnEl = el('alreadyWarn');
    if(exists){ warnEl.textContent = t('alreadyCheckedIn'); warnEl.classList.remove('hidden'); el('btnConfirmAttendance').disabled = true; }
    else { warnEl.classList.add('hidden'); el('btnConfirmAttendance').disabled = false; }
    el('cardPicked').classList.remove('hidden');
  }
    el('pickedLine').textContent = `${t('student')}: ${c.name} (${c.classId} #${c.number})`;
    el('pickedGroup').textContent = `${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`;
    el('pickedVenue').textContent = c.venue||'';
    el('cardPicked').classList.remove('hidden');
  }

  function confirmAttendance(){
    const p = Number(el('inputParents').value||1); const c = state.picked; if(!c) return;
    const duplicate = hasCheckedIn(c.classId, c.number);
    if(duplicate){
      // Do NOT record again; just show venue and message
      el('doneTitle').textContent = t('alreadyCheckedIn');
      el('doneSub').textContent = `${t('student')}: ${c.name} (${c.classId} #${c.number}) • ${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`;
      el('doneVenue').textContent = c.venue;
      el('cardPicked').classList.add('hidden');
      el('cardDone').classList.remove('hidden');
      return;
    }
    const record = { ts: Date.now(), classId:c.classId, number:c.number, name:c.name, group:c.group, venue:c.venue, parents: Math.max(1, p), lang: state.lang };
    const list = loadCheckins(); list.push(record); saveCheckins(list);
    state.picked = null; el('cardPicked').classList.add('hidden');
    el('doneTitle').textContent = t('attendanceConfirmed');
    el('doneSub').textContent = `${t('student')}: ${record.name} (${record.classId} #${record.number}) • ${t('group')}: ${record.group==='odd'?t('odd'):t('even')}`;
    el('doneVenue').textContent = record.venue;
    el('cardDone').classList.remove('hidden');
  };
    const list = loadCheckins(); list.push(record); saveCheckins(list);
    state.picked = null; el('cardPicked').classList.add('hidden');
    el('doneSub').textContent = `${t('student')}: ${record.name} (${record.classId} #${record.number}) • ${t('group')}: ${record.group==='odd'?t('odd'):t('even')}`;
    el('doneVenue').textContent = record.venue;
    el('cardDone').classList.remove('hidden');
  }

  function refreshAdmin(){
    const q = el('adminSearch').value.toLowerCase();
    const list = loadCheckins().filter(r=>!q || [r.name,r.classId,String(r.number),r.venue,r.group].some(v=>String(v).toLowerCase().includes(q)));
    const totalParents = list.reduce((a,r)=>a+(Number(r.parents)||0),0);
    el('totalParents').textContent = totalParents;
    el('totalFamilies').textContent = list.length;
    const root = el('adminList'); root.innerHTML='';
    list.forEach(r=>{
      const item = document.createElement('div'); item.className='item card';
      item.innerHTML = `<div class="content row" style="justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-weight:600">${r.name} (${r.classId} #${r.number})</div>
          <div class="muted" style="font-size:12px">${new Date(r.ts).toLocaleString()} • ${r.group} • ${r.venue}</div>
        </div>
        <div class="big">×${r.parents}</div>
      </div>`;
      root.appendChild(item);
    });
  }

  function exportCSV(){
    const rows = loadCheckins();
    const headers = ["timestamp_iso","class","number","name","group","venue","parents","lang"];
    const lines = [headers.join(",")];
    rows.forEach(r=>{
      const iso = new Date(r.ts).toISOString();
      const values = [iso,r.classId,r.number,r.name,r.group,r.venue,r.parents,r.lang].map(v=>`"${String(v).replaceAll('"','""')}"`);
      lines.push(values.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download='f1_checkins_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ====== Event bindings
  window.addEventListener('DOMContentLoaded', () => {
    // language buttons
    el('btnEn').addEventListener('click',()=>setLang('en'));
    el('btnZh').addEventListener('click',()=>setLang('zh'));

    // top-right
    el('btnAdmin').addEventListener('click',()=>{ show('Admin'); el('inputPIN').value=''; });

    // home
    el('btnStart').addEventListener('click',()=> show('Flow'));

    // flow
    el('modeNumber').addEventListener('click',()=>{ el('panelNumber').classList.remove('hidden'); el('panelName').classList.add('hidden'); el('modeNumber').classList.add('primary'); el('modeName').classList.remove('primary'); el('modeName').classList.add('secondary'); });
    el('modeName').addEventListener('click',()=>{ el('panelName').classList.remove('hidden'); el('panelNumber').classList.add('hidden'); el('modeName').classList.add('primary'); el('modeNumber').classList.remove('primary'); el('modeNumber').classList.add('secondary'); });

    el('btnConfirmByNo').addEventListener('click',()=>{
      const cls = el('selectClass').value; const n = Number(el('inputNumber').value||0);
      if(!cls||!n||!state.roster){ alert(t('noMatch')); return; }
      const res = findByNumber(cls, n); if(res){ state.picked = res; el('inputParents').value='1'; el('cardDone').classList.add('hidden'); updatePickedCard(); } else { alert(t('noMatch')); }
    });

    el('inputName').addEventListener('input',()=>{
      const cls = el('selectClass').value; const q = el('inputName').value; const root = el('suggestions'); root.innerHTML='';
      suggestionsFor(cls, q).forEach(s=>{
        const b=document.createElement('button'); b.className='secondary'; b.textContent = s.display_name||s.name; b.addEventListener('click',()=>{
          const res = findByName(cls, s.display_name||s.name); if(res){ state.picked=res; el('inputParents').value='1'; el('cardDone').classList.add('hidden'); updatePickedCard(); }
        }); root.appendChild(b);
      });
    });

    el('btnConfirmAttendance').addEventListener('click', confirmAttendance);
    el('btnBack').addEventListener('click',()=>{ state.picked=null; el('cardPicked').classList.add('hidden'); });
    el('btnDoneBack').addEventListener('click',()=>{ el('cardDone').classList.add('hidden'); });
    el('btnDoneReset').addEventListener('click',()=>{ el('cardDone').classList.add('hidden'); el('selectClass').value=''; el('inputNumber').value=''; el('inputName').value=''; el('suggestions').innerHTML=''; });

    // admin
    el('btnUnlock').addEventListener('click',()=>{ if(el('inputPIN').value===ADMIN_PIN){ show('AdminOpen'); refreshAdmin(); } });
    el('btnAdminBack').addEventListener('click',()=> show('Home'));
    el('btnLock').addEventListener('click',()=> show('Home'));
    el('adminSearch').addEventListener('input', refreshAdmin);
    el('btnExport').addEventListener('click', exportCSV);

    // dropdown change clears panels
    el('selectClass').addEventListener('change',()=>{ el('inputNumber').value=''; el('inputName').value=''; el('suggestions').innerHTML=''; state.picked=null; el('cardPicked').classList.add('hidden'); el('cardDone').classList.add('hidden'); });

    // init from storage
    try{ const r = JSON.parse(localStorage.getItem('f1.roster')||'null'); if(r) state.roster=r; }catch{}
    renderAll(); show('Home');
    // show loading indicator
    el('rosterStatus').textContent = 'Loading roster.xlsx…';
    (async () => {
      await tryAutoLoad();
      if(state.roster){ el('rosterStatus').textContent = 'Roster loaded.'; }
      else { el('rosterStatus').textContent = 'Could not load roster.xlsx in this folder.'; }
    })();

    // ====== Lightweight self-tests (console only) ======
    try {
      const sampleRows = [
        { class:'1B', number:1, name:'A', group:'Odd', venue:'M42(4/F)' },
        { class:'1B', number:2, name:'B', group:'Even', venue:'M43(4/F)' },
      ];
      const data = buildData(sampleRows);
      console.assert(data.classes['1B'].odd.students.length===1, 'odd count');
      console.assert(data.classes['1B'].even.students.length===1, 'even count');
      const prevRoster = state.roster; state.roster = data;
      console.assert(findByNumber('1B',2)?.name==='B', 'findByNumber');
      console.assert(suggestionsFor('1B','A').length===1, 'suggestionsFor');
      const prevCheck = loadCheckins();
      saveCheckins([]);
      console.assert(hasCheckedIn('1B',1)===false, 'hasCheckedIn pre');
      saveCheckins([{ ts:Date.now(), classId:'1B', number:1, name:'A', group:'odd', venue:'M42(4/F)', parents:1, lang:'en' }]);
      console.assert(hasCheckedIn('1B',1)===true, 'hasCheckedIn true');
      console.assert(hasCheckedIn('1B',2)===false, 'hasCheckedIn other false');
      saveCheckins(prevCheck);
      state.roster = prevRoster;
      console.log('[Self-tests] passed');
    } catch(e) { console.warn('[Self-tests] failed', e); }
  });
  </script>
</body>
</html>
