<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F1 Growth Celebration – Self Check-in</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --primary:#2563eb; --ring:#93c5fd; --danger:#b91c1c; --danger-bg:#fee2e2; --danger-br:#fecaca;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(#fff,#f8fafc);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:#ffffffd9;backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:860px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 18px rgba(15,23,42,.06)}
    .card .content{padding:18px}
    h1{font-size:20px;margin:0;font-weight:700}
    h2{font-size:18px;margin:0 0 8px 0}
    p{margin:0 0 8px 0;color:var(--muted)}
    button{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    button.primary:active{transform:translateY(1px)}
    button.secondary{background:#f1f5f9}
    button:focus{outline:3px solid var(--ring);outline-offset:2px}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    input:focus,select:focus{outline:3px solid var(--ring);border-color:var(--primary)}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .list{display:grid;gap:8px}
    .list .item{display:flex;justify-content:space-between;align-items:center}
    .big{font-size:26px;font-weight:800}
    .xl{font-size:22px;font-weight:700}
    .lang-toggle button{padding:8px 10px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
    .chip.danger{background:var(--danger-bg);border-color:var(--danger-br);color:var(--danger)}
    .foot{padding:28px;text-align:center;color:var(--muted);font-size:12px}
    @media (min-width:700px){ .two{grid-template-columns:1fr 1fr} }
  </style>
  <!-- Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Traditional/Simplified conversion (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
</head>
<body>
  <header>
    <div class="container row" style="align-items:center;justify-content:space-between;">
      <div class="row" style="align-items:center;gap:10px">
        <h1 id="title">F1 Growth Celebration Ceremony</h1>
        <span class="pill" id="datePill">25/10/2025</span>
      </div>
      <div class="row lang-toggle">
        <span class="muted" id="langLabel">Language</span>
        <button id="btnEn" class="secondary">English</button>
        <button id="btnZh" class="secondary">中文</button>
        <button id="btnAdmin" class="primary">Staff</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:16px;">
    <!-- No Start button. Parents land here directly. -->
    <section id="pageFlow">
      <div class="card"><div class="content grid">
        <div id="rosterStatus" class="muted"></div>

        <div>
          <label id="labelSelectClass">Select Class</label>
          <select id="selectClass"><option value="" id="optChoose">Choose</option></select>
        </div>

        <div class="btns">
          <button id="modeNumber" class="primary">Class No.</button>
          <button id="modeName" class="secondary">Choose from list</button>
        </div>

        <div id="panelNumber" class="grid">
          <label id="labelEnterNo">Enter class number (e.g., 12)</label>
          <input id="inputNumber" inputmode="numeric" pattern="[0-9]*" placeholder="12" />
          <button id="btnConfirmByNo" class="primary">Confirm student</button>
        </div>

        <div id="panelName" class="grid hidden">
          <label id="labelStudentName">Student name</label>
          <select id="selectStudent"><option value="" id="optStudentChoose">Choose a student</option></select>
        </div>
      </div></div>
    </section>

    <div id="cardPicked" class="card hidden"><div class="content grid">
      <div class="xl" id="pickedLine">Student: –</div>
      <div class="muted" id="pickedGroup">Group: –</div>
      <div class="muted">Venue: <span id="pickedVenue" style="font-weight:700"></span></div>
      <div id="alreadyWarn" class="chip danger hidden"></div>
      <div>
        <label id="labelParents">No. of parents attending</label>
        <input id="inputParents" inputmode="numeric" pattern="[0-9]*" value="1" />
      </div>
      <div class="btns">
        <button id="btnConfirmAttendance" class="primary">Confirm attendance</button>
        <button id="btnBack" class="secondary">Back</button>
      </div>
    </div></div>

    <div id="cardDone" class="card hidden"><div class="content grid">
      <div class="xl" id="doneTitle">Attendance confirmed</div>
      <div class="muted" id="doneSub">Student: –</div>
      <div class="muted" id="donePrompt">After the briefing, please proceed to your designated room:</div>
      <div class="big" id="doneVenue">M42</div>
      <div class="btns">
        <button id="btnDoneBack" class="primary">Back</button>
        <button id="btnDoneReset" class="secondary">Reset</button>
      </div>
    </div></div>

    <!-- Staff (locked) -->
    <section id="pageAdmin" class="hidden">
      <div class="card"><div class="content grid">
        <h2 id="adminTitle">Staff mode</h2>
        <label id="labelPIN">Enter PIN</label>
        <input id="inputPIN" inputmode="numeric" />
        <div class="btns">
          <button id="btnUnlock" class="primary">Unlock</button>
          <button id="btnAdminBack" class="secondary">Back</button>
        </div>
      </div></div>
    </section>

    <!-- Staff (unlocked) -->
    <section id="pageAdminOpen" class="hidden">
      <div class="card"><div class="content grid">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="xl" id="adminOpenTitle">Staff mode</div>
          <div class="btns">
            <button id="btnExport" class="primary">Export CSV</button>
            <button id="btnLock" class="secondary">Lock</button>
          </div>
        </div>
        <div class="two grid">
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalParents">Total parents checked-in</div>
            <div class="big" id="totalParents">0</div>
          </div></div>
          <div class="card"><div class="content">
            <div class="muted" id="labelTotalFamilies">Total families checked-in</div>
            <div class="big" id="totalFamilies">0</div>
          </div></div>
        </div>
        <input id="adminSearch" placeholder="Search…" />
        <div class="list" id="adminList"></div>
      </div></div>
    </section>

    <div class="foot">© 2025 F1 Growth Celebration</div>
  </main>

  <script>
  // ====== CONFIG ======
  const ADMIN_PIN = "1025";

  // ====== I18N ======
  const I18N = {
    en: {
      appTitle: "F1 Growth Celebration Ceremony",
      language: "Language",
      staff: "Staff",
      selectClass: "Select Class",
      choose: "Choose",
      chooseStudent: "Choose a student",
      classNo: "Class No.",
      searchByName: "Choose from list",
      enterNumber: "Enter class number (e.g., 12)",
      studentName: "Student name",
      noMatch: "No matching student",
      confirmStudent: "Confirm student",
      student: "Student",
      group: "Group",
      odd: "Odd",
      even: "Even",
      parentsAttending: "No. of parents attending",
      confirmAttendance: "Confirm attendance",
      attendanceConfirmed: "Attendance confirmed",
      proceedToVenue: "After the briefing, please proceed to your designated room:",
      back: "Back",
      reset: "Reset",
      admin: "Staff mode",
      adminPIN: "Enter PIN",
      unlock: "Unlock",
      lock: "Lock",
      exportCSV: "Export CSV",
      totalParents: "Total parents checked-in",
      totalFamilies: "Total families checked-in",
      loadFail: "Could not load roster.xlsx in this folder.",
      loadSuccess: "Roster loaded. You may check in now.",
    },
    zh: {
      appTitle: "中一成長祝福禮",
      language: "語言",
      staff: "職員",
      selectClass: "選擇班別",
      choose: "請選擇",
      chooseStudent: "請選擇學生",
      classNo: "學號",
      searchByName: "從名單選擇",
      enterNumber: "輸入學號（例如：12）",
      studentName: "學生姓名",
      noMatch: "找不到相符學生",
      confirmStudent: "確認學生",
      student: "學生",
      group: "組別",
      odd: "單號",
      even: "雙號",
      parentsAttending: "到場家長人數",
      confirmAttendance: "確認出席",
      attendanceConfirmed: "已完成簽到",
      proceedToVenue: "簡介會結束後，請前往指定課室：",
      back: "返回",
      reset: "重設",
      admin: "職員模式",
      adminPIN: "輸入密碼",
      unlock: "解鎖",
      lock: "上鎖",
      exportCSV: "匯出 CSV",
      totalParents: "已簽到家長總數",
      totalFamilies: "已簽到家庭數",
      loadFail: "未能載入 roster.xlsx。",
      loadSuccess: "已載入名單，可開始簽到。",
    },
  };
  function t(key){ return I18N[state.lang][key]; }

  // ====== State & Storage ======
  const state = {
    lang: localStorage.getItem('f1.lang') || 'en',
    roster: null,      // built roster
    picked: null,      // current selected student
  };
  const el = id => document.getElementById(id);
  function loadCheckins(){ try{return JSON.parse(localStorage.getItem('f1.checkins')||'[]')}catch{return[]} }
  function saveCheckins(list){ localStorage.setItem('f1.checkins', JSON.stringify(list)); }
  function hasCheckedIn(classId, number){ return loadCheckins().some(r => r.classId===classId && Number(r.number)===Number(number)); }

  // ====== OpenCC (optional)
  let _convT2S = null, _convS2T = null;
  try { if (window.OpenCC && typeof OpenCC.Converter === 'function') { _convT2S = OpenCC.Converter({ from: 'tw', to: 'cn' }); _convS2T = OpenCC.Converter({ from: 'cn', to: 'tw' }); } } catch {}

  // ====== Helpers
  const stripZW = s => String(s||'').replace(/[\u200B\u200C\u200D\uFEFF]/g,''); // zero-width chars
  function displayLabel(stu){
    const ch = stripZW(stu.ch_name||'').trim();
    const en = stripZW(stu.en_name||'').trim();
    if(ch && en) return `${ch} / ${en}`;
    return ch || en || '';
  }
  function setText(id, txt){ const n=el(id); if(!n) return false; n.textContent=txt; return true; }

  // ====== Render / i18n
  function renderAll(){
    setText('title', t('appTitle'));
    setText('langLabel', t('language'));
    setText('btnAdmin', t('staff'));
    setText('labelSelectClass', t('selectClass'));
    setText('optChoose', t('choose'));
    setText('modeNumber', t('classNo'));
    setText('modeName', t('searchByName'));
    setText('labelEnterNo', t('enterNumber'));
    setText('btnConfirmByNo', t('confirmStudent'));
    setText('labelStudentName', t('studentName'));
    setText('labelParents', t('parentsAttending'));
    setText('btnConfirmAttendance', t('confirmAttendance'));
    setText('btnBack', t('back'));
    setText('doneTitle', t('attendanceConfirmed'));
    setText('donePrompt', t('proceedToVenue'));
    setText('btnDoneBack', t('back'));
    setText('btnDoneReset', t('reset'));
    setText('adminTitle', t('admin'));
    setText('labelPIN', t('adminPIN'));
    setText('btnUnlock', t('unlock'));
    setText('btnAdminBack', t('back'));
    setText('adminOpenTitle', t('admin'));
    setText('btnExport', t('exportCSV'));
    setText('btnLock', t('lock'));
    setText('labelTotalParents', t('totalParents'));
    setText('labelTotalFamilies', t('totalFamilies'));
    setText('optStudentChoose', t('chooseStudent'));
    fillClassSelect();
  }
  function setLang(lang){ state.lang=lang; localStorage.setItem('f1.lang',lang); renderAll(); }

  // ====== Build roster
  function normalizeRow(r){
    // Normalize header keys for Excel/Safari issues (NBSP, spaces, underscores, casing)
    const NBSP = String.fromCharCode(160);
    const normKey = k => String(k||'').toLowerCase().split(NBSP).join(' ').replace(/[\s_]+/g,'').trim();
    const pickAny = (obj, keys)=>{
      const m = new Map();
      for(const k of Object.keys(obj)) m.set(normKey(k), k);
      for(const want of keys){ const nk = normKey(want); if(m.has(nk)) return obj[m.get(nk)]; }
      return undefined;
    };
    const toStr = v => String(v==null?'':v).split(NBSP).join(' ').trim();

    const cls = toStr(pickAny(r, ['class','Class','CLASS']));
    const number = Number(pickAny(r, ['number','Number','no','No','NO','class_no','classno'])||0);

    const en = toStr(pickAny(r, [
      'en_name','enName','EN_NAME','english','English','english_name','englishname',
      'name_en','student_english','studentenglish','English Name','EnglishName'
    ]));
    const ch = toStr(pickAny(r, [
      'ch_name','chName','CH_NAME','chinese','Chinese','chinesename','chinese_name',
      'name_ch','chi_name','student_chinese','studentchinese','中文姓名','CH Name','CHName'
    ]));

    const grpRaw = toStr(pickAny(r, ['group','Group'])).toLowerCase();
    const group = grpRaw.includes('odd') ? 'odd' : grpRaw.includes('even') ? 'even' : (number%2 ? 'odd':'even');

    const venue = toStr(pickAny(r, ['venue','Venue','room','Room','classroom']));

    const parents = Number(pickAny(r, ['parents_expected','expected_parents','parents','no_of_parents','parents_coming','parent_count','ParentCount','Parents','Expected Parents'])||0);

    return { cls, number, en_name: en, ch_name: ch, group, venue, parents_expected: (Number.isFinite(parents)&&parents>0)?parents:0 };
  }
  function buildData(rows){
    const data = { classes:{} };
    rows.forEach(r=>{
      const { cls, number, en_name, ch_name, group, venue, parents_expected } = normalizeRow(r);
      if(!cls || !number) return; // keep row even if names blank (some devices show hidden chars)
      if(!data.classes[cls]) data.classes[cls] = { odd:{venue:null,students:[]}, even:{venue:null,students:[]} };
      const bucket = data.classes[cls][group];
      if(!bucket.venue && venue) bucket.venue = venue;
      const display_name = displayLabel({en_name, ch_name}) || `#${number}`;
      bucket.students.push({ number, en_name, ch_name, display_name, expected_parents: (Number.isFinite(parents_expected)&&parents_expected>0) ? parents_expected : null });
    });
    Object.values(data.classes).forEach(cb=>{
      cb.odd.students.sort((a,b)=>a.number-b.number);
      cb.even.students.sort((a,b)=>a.number-b.number);
    });
    return data;
  }

  // ====== XLSX load
  async function parseExcelArrayBuffer(buf){
    const wb = XLSX.read(new Uint8Array(buf), { type:'array' });
    const ws = wb.Sheets['roster'] || wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error('No sheets found');
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
    return buildData(rows);
  }
  async function loadRosterFromUrl(url){
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    if(/\.json($|\?)/i.test(url)){ return await res.json(); }
    const ab = await res.arrayBuffer();
    return await parseExcelArrayBuffer(ab);
  }

  // ====== UI data flows
  function fillClassSelect(){
    const sel = el('selectClass'); if(!sel) return;
    const keep = sel.value;
    sel.innerHTML = `<option value="">${t('choose')}</option>`;
    if(state.roster){
      Object.keys(state.roster.classes).sort().forEach(c=>{
        const opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);
      });
      if(Object.keys(state.roster.classes).includes(keep)) sel.value = keep;
      populateStudentsUI();
    }
  }
  function populateStudentsUI(){
    const cls = (el('selectClass') && el('selectClass').value) || '';
    const sel = el('selectStudent'); if(!sel) return;
    sel.innerHTML = `<option value="">${t('chooseStudent')}</option>`;
    if(!state.roster || !cls || !state.roster.classes[cls]) return;
    const cb = state.roster.classes[cls];
    const makeOption = (s, group, venue) => {
      const opt = document.createElement('option');
      opt.value = String(s.number);
      const name = displayLabel(s);
      const labelCore = name || `#${s.number}`;
      const grpText = group==='odd'?t('odd'):t('even');
      const text = `${labelCore} (#${s.number} • ${grpText})${hasCheckedIn(cls, s.number) ? ' ✓' : ''}`;
      // iOS/Safari friendly option text
      opt.text = ''; opt.textContent = ''; opt.label = labelCore;
      opt.appendChild(document.createTextNode(text));
      opt.dataset.group = group;
      opt.dataset.venue = venue || '';
      opt.dataset.expected = (s.expected_parents!=null) ? String(s.expected_parents) : '';
      return opt;
    };
    cb.odd.students.forEach(s=> sel.appendChild(makeOption(s,'odd', cb.odd.venue)));
    cb.even.students.forEach(s=> sel.appendChild(makeOption(s,'even', cb.even.venue)));
  }
  function findByNumber(cls, n){
    const cb = state.roster.classes[cls]; if(!cb) return null;
    const sOdd = cb.odd.students.find(s=>s.number===n);
    if(sOdd) return { classId:cls, number:n, label: displayLabel(sOdd) || sOdd.display_name, group:'odd', venue: cb.odd.venue||'', expected_parents: sOdd.expected_parents };
    const sEven = cb.even.students.find(s=>s.number===n);
    if(sEven) return { classId:cls, number:n, label: displayLabel(sEven) || sEven.display_name, group:'even', venue: cb.even.venue||'', expected_parents: sEven.expected_parents };
    return null;
  }

  function updatePickedCard(){
    const c = state.picked; if(!c){ const card=el('cardPicked'); if(card) card.classList.add('hidden'); return; }
    setText('pickedLine', `${t('student')}: ${c.label} (${c.classId} #${c.number})`);
    setText('pickedGroup', `${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`);
    setText('pickedVenue', c.venue||'');
    const exists = hasCheckedIn(c.classId, c.number);
    const warnEl = el('alreadyWarn');
    const btn = el('btnConfirmAttendance');
    const ip = el('inputParents');
    if(warnEl){
      if(exists){ warnEl.textContent = I18N[state.lang].alreadyCheckedIn || 'Already checked in'; warnEl.classList.remove('hidden'); if(btn) btn.disabled=true; }
      else { warnEl.classList.add('hidden'); if(btn) btn.disabled=false; }
    }
    if(ip && !exists){ ip.value = (c.expected_parents && Number(c.expected_parents)>0) ? String(c.expected_parents) : '1'; }
    const card=el('cardPicked'); if(card) card.classList.remove('hidden');
  }
  function confirmAttendance(){
    const p = Math.max(1, Number((el('inputParents')&&el('inputParents').value)||1));
    const c = state.picked; if(!c) return;
    if(hasCheckedIn(c.classId, c.number)){
      setText('doneTitle', I18N[state.lang].alreadyCheckedIn || 'Already checked in');
      setText('doneSub', `${t('student')}: ${c.label} (${c.classId} #${c.number}) • ${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`);
      setText('doneVenue', c.venue);
      const cp=el('cardPicked'); if(cp) cp.classList.add('hidden');
      const cd=el('cardDone'); if(cd) cd.classList.remove('hidden');
      return;
    }
    const list = loadCheckins();
    list.push({ ts:Date.now(), classId:c.classId, number:c.number, name:c.label, group:c.group, venue:c.venue, parents:p, lang:state.lang });
    saveCheckins(list);
    setText('doneTitle', t('attendanceConfirmed'));
    setText('doneSub', `${t('student')}: ${c.label} (${c.classId} #${c.number}) • ${t('group')}: ${c.group==='odd'?t('odd'):t('even')}`);
    setText('doneVenue', c.venue);
    const cp=el('cardPicked'); if(cp) cp.classList.add('hidden');
    const cd=el('cardDone'); if(cd) cd.classList.remove('hidden');
    state.picked = null;
  }

  // ====== Admin bits (minimal)
  function refreshAdmin(){
    const q = (el('adminSearch')&&el('adminSearch').value||'').toLowerCase();
    const list = loadCheckins().filter(r=>!q || [r.name,r.classId,String(r.number),r.venue,r.group].some(v=>String(v).toLowerCase().includes(q)));
    const totalParents = list.reduce((a,r)=>a+(Number(r.parents)||0),0);
    setText('totalParents', String(totalParents));
    setText('totalFamilies', String(list.length));
    const root = el('adminList'); if(root){
      root.innerHTML='';
      list.forEach(r=>{
        const item = document.createElement('div'); item.className='item card';
        item.innerHTML = `<div class="content row" style="justify-content:space-between;align-items:center;gap:12px">
          <div>
            <div style="font-weight:600">${r.name} (${r.classId} #${r.number})</div>
            <div class="muted" style="font-size:12px">${new Date(r.ts).toLocaleString()} • ${r.group} • ${r.venue}</div>
          </div>
          <div class="big">×${r.parents}</div>
        </div>`;
        root.appendChild(item);
      });
    }
  }
  function exportCSV(){
    const rows = loadCheckins();
    const headers = ["timestamp_iso","class","number","name","group","venue","parents","lang"];
    const lines = [headers.join(",")];
    rows.forEach(r=>{
      const iso = new Date(r.ts).toISOString();
      const values = [iso,r.classId,r.number,r.name,r.group,r.venue,r.parents,r.lang].map(v=>`"${String(v).replace(/"/g,'""')}"`);
      lines.push(values.join(','));
    });
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download='f1_checkins_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ====== Boot
  function updateRosterStatus(){ setText('rosterStatus', state.roster ? t('loadSuccess') : t('loadFail')); }
  async function tryAutoLoad(){
    if(state.roster) return;
    const params = new URLSearchParams(location.search);
    const rosterParam = params.get('roster')||params.get('xls')||params.get('excel');
    const candidates = [];
    if(rosterParam) candidates.push(rosterParam);
    candidates.push('./roster.xlsx');
    for(const u of candidates){
      try{ state.roster = await loadRosterFromUrl(u); localStorage.setItem('f1.roster', JSON.stringify(state.roster)); break; }
      catch(e){ console.warn('Auto-load failed', u, e); }
    }
    fillClassSelect();
    updateRosterStatus();
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    // Language
    const btnEn=el('btnEn'), btnZh=el('btnZh');
    if(btnEn) btnEn.addEventListener('click',()=>setLang('en'));
    if(btnZh) btnZh.addEventListener('click',()=>setLang('zh'));

    // Admin
    const btnAdmin=el('btnAdmin'); if(btnAdmin) btnAdmin.addEventListener('click',()=>{ el('pageAdmin').classList.remove('hidden'); });
    const btnAdminBack=el('btnAdminBack'); if(btnAdminBack) btnAdminBack.addEventListener('click',()=>{ el('pageAdmin').classList.add('hidden'); });
    const btnUnlock=el('btnUnlock'); if(btnUnlock) btnUnlock.addEventListener('click',()=>{ const pin=el('inputPIN').value; if(pin==='1025'){ el('pageAdmin').classList.add('hidden'); el('pageAdminOpen').classList.remove('hidden'); refreshAdmin(); }});
    const btnLock=el('btnLock'); if(btnLock) btnLock.addEventListener('click',()=>{ el('pageAdminOpen').classList.add('hidden'); });
    const adminSearch=el('adminSearch'); if(adminSearch) adminSearch.addEventListener('input', refreshAdmin);
    const btnExport=el('btnExport'); if(btnExport) btnExport.addEventListener('click', exportCSV);

    // Mode toggles
    const modeNumber=el('modeNumber'), modeName=el('modeName');
    if(modeNumber) modeNumber.addEventListener('click',()=>{ el('panelNumber').classList.remove('hidden'); el('panelName').classList.add('hidden'); modeNumber.classList.add('primary'); modeName.classList.remove('primary'); modeName.classList.add('secondary'); });
    if(modeName) modeName.addEventListener('click',()=>{ el('panelName').classList.remove('hidden'); el('panelNumber').classList.add('hidden'); modeName.classList.add('primary'); modeNumber.classList.remove('primary'); modeNumber.classList.add('secondary'); });

    // Confirm by number
    const btnConfirmByNo=el('btnConfirmByNo');
    if(btnConfirmByNo) btnConfirmByNo.addEventListener('click',()=>{
      const cls = el('selectClass').value; const n = Number(el('inputNumber').value||0);
      if(!cls || !n || !state.roster){ alert(t('noMatch')); return; }
      const res = findByNumber(cls, n);
      if(res){ state.picked=res; el('cardDone').classList.add('hidden'); updatePickedCard(); } else { alert(t('noMatch')); }
    });

    // Dropdown by name
    const selectStudent=el('selectStudent');
    if(selectStudent) selectStudent.addEventListener('change',()=>{
      const cls = el('selectClass').value; const val = selectStudent.value;
      if(!cls || !val || !state.roster) return;
      const res = findByNumber(cls, Number(val));
      if(res){ state.picked=res; el('cardDone').classList.add('hidden'); updatePickedCard(); }
    });

    // Confirm attendance
    const btnConfirmAttendance=el('btnConfirmAttendance'); if(btnConfirmAttendance) btnConfirmAttendance.addEventListener('click', confirmAttendance);
    const btnBack=el('btnBack'); if(btnBack) btnBack.addEventListener('click',()=>{ state.picked=null; el('cardPicked').classList.add('hidden'); });
    const btnDoneBack=el('btnDoneBack'); if(btnDoneBack) btnDoneBack.addEventListener('click',()=>{ el('cardDone').classList.add('hidden'); });
    const btnDoneReset=el('btnDoneReset'); if(btnDoneReset) btnDoneReset.addEventListener('click',()=>{ el('cardDone').classList.add('hidden'); el('selectClass').value=''; el('inputNumber').value=''; el('selectStudent').value=''; });

    // Class change
    const selectClass=el('selectClass'); if(selectClass) selectClass.addEventListener('change',()=>{
      el('inputNumber').value=''; el('selectStudent').value=''; state.picked=null; el('cardPicked').classList.add('hidden'); el('cardDone').classList.add('hidden');
      populateStudentsUI();
    });

    // Init
    try{ const cached = JSON.parse(localStorage.getItem('f1.roster')||'null'); if(cached) state.roster=cached; }catch{}
    renderAll();
    setText('rosterStatus','Loading roster.xlsx…');
    (async()=>{ await tryAutoLoad(); })();
  });
  </script>
</body>
</html>
