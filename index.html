/** Google Apps Script â€” Web App backend for F1 check-ins
 * Deploy:  Deploy > New deployment > Type: Web app
 *  - Execute as: Me
 *  - Who has access: Anyone
 * Copy the Web app URL and paste into BACKEND_URL in index.html
 */

const SHEET_NAME = 'checkins';
const HEADERS = ['timestamp_iso','class','number','name','group','venue','parents','lang'];

function _sheet() {
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) {
    sh = ss.insertSheet(SHEET_NAME);
    sh.appendRow(HEADERS);
  }
  return sh;
}

function _jsonOut(obj) {
  const out = ContentService.createTextOutput(JSON.stringify(obj));
  out.setMimeType(ContentService.MimeType.JSON);
  // CORS for GitHub Pages
  out.setHeader('Access-Control-Allow-Origin', '*');
  out.setHeader('Access-Control-Allow-Methods', 'GET,POST');
  out.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  return out;
}

// GET ?action=list  -> returns all rows
// GET ?action=stats -> returns totals only
function doGet(e) {
  const action = (e.parameter.action || '').toLowerCase();
  const sh = _sheet();
  const values = sh.getDataRange().getValues();

  if (action === 'list') {
    const items = [];
    for (let i = 1; i < values.length; i++) {
      const r = values[i];
      items.push({
        timestamp_iso: r[0], classId: String(r[1]), number: Number(r[2]),
        name: String(r[3]), group: String(r[4]), venue: String(r[5]),
        parents: Number(r[6]), lang: String(r[7])
      });
    }
    return _jsonOut({ status: 'ok', items });
  }

  if (action === 'stats') {
    let totalParents = 0, totalFamilies = Math.max(0, values.length - 1);
    for (let i = 1; i < values.length; i++) totalParents += Number(values[i][6]) || 0;
    return _jsonOut({ status: 'ok', totalParents, totalFamilies });
  }

  return _jsonOut({ status: 'ok', message: 'ping' });
}

// POST action=checkin&json=<payload>
// Avoids CORS preflight by using URL-encoded body from the client.
function doPost(e) {
  const action = (e.parameter.action || '').toLowerCase();
  if (action !== 'checkin') return _jsonOut({ status: 'unknown-action' });

  // Accept either URL-encoded param 'json' or raw JSON
  let data = {};
  try {
    data = e.parameter.json ? JSON.parse(e.parameter.json) :
           e.postData && e.postData.contents ? JSON.parse(e.postData.contents) : {};
  } catch (err) {
    return _jsonOut({ status: 'error', message: 'bad-json' });
  }

  if (!data || !data.classId || !data.number) {
    return _jsonOut({ status: 'error', message: 'missing-fields' });
  }

  const sh = _sheet();
  const values = sh.getDataRange().getValues();

  // De-duplicate by class + number
  let exists = false, existingRow = null;
  for (let i = 1; i < values.length; i++) {
    if (String(values[i][1]) === String(data.classId) &&
        Number(values[i][2]) === Number(data.number)) {
      exists = true;
      existingRow = {
        timestamp_iso: values[i][0], classId: values[i][1], number: values[i][2],
        name: values[i][3], group: values[i][4], venue: values[i][5],
        parents: values[i][6], lang: values[i][7]
      };
      break;
    }
  }

  if (exists) {
    return _jsonOut({ status: 'duplicate', existing: existingRow });
  }

  sh.appendRow([
    new Date().toISOString(),
    String(data.classId),
    Number(data.number),
    String(data.name || ''),
    String(data.group || ''),
    String(data.venue || ''),
    Number(data.parents || 1),
    String(data.lang || '')
  ]);

  return _jsonOut({ status: 'ok' });
}
