<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>F1 Growth Celebration – Self Check-in</title>
<meta name="theme-color" content="#ffffff"/>
<style>
  :root{--bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#475569;--border:#e2e8f0;--primary:#2563eb;--ring:#93c5fd;--danger:#b91c1c;--danger-bg:#fee2e2;--danger-br:#fecaca}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(#fff,#f8fafc);color:var(--text)}
  header{position:sticky;top:0;z-index:50;background:#ffffffd9;backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
  .container{max-width:860px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 18px rgba(15,23,42,.06)}
  .content{padding:18px}
  h1{font-size:20px;margin:0;font-weight:700}
  h2{font-size:18px;margin:0 0 8px 0}
  p{margin:0 0 8px 0;color:var(--muted)}
  button{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
  button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  button.secondary{background:#f1f5f9}
  button:focus{outline:3px solid var(--ring);outline-offset:2px}
  button[disabled]{opacity:.6;cursor:not-allowed}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:11px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
  input:focus,select:focus{outline:3px solid var(--ring);border-color:var(--primary)}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .muted{color:var(--muted)}
  .hidden{display:none !important}
  .big{font-size:26px;font-weight:800}
  .xl{font-size:22px;font-weight:700}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
  .chip.danger{background:var(--danger-bg);border-color:var(--danger-br);color:var(--danger)}
  .foot{padding:28px;text-align:center;color:var(--muted);font-size:12px}
  @media (min-width:700px){.two{grid-template-columns:1fr 1fr}}
</style>
<!-- Excel library with CDN → local fallback -->
<script>
(function(){
  function inject(src, onload){
    var s=document.createElement('script');
    s.src=src; s.defer=true;
    s.onload=onload;
    s.onerror=function(){
      console.warn('Failed to load', src);
      var eb=document.getElementById('errorBanner');
      if(eb){ eb.classList.remove('hidden'); eb.textContent='Error loading '+src; }
    };
    document.head.appendChild(s);
  }
  // Try CDN first; fall back to local file
  inject('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js', function(){ window.__xlsxReady=true; });
  setTimeout(function(){
    if(!window.__xlsxReady){ inject('./xlsx.full.min.js', function(){ window.__xlsxReady=true; }); }
  }, 1200);
})();
</script>

</head>
<body>
<header>
  <div class="container row" style="align-items:center;justify-content:space-between;">
    <div class="row" style="align-items:center;gap:10px">
      <h1 id="title">F1 Growth Celebration Ceremony</h1>
      <span class="pill" id="datePill">25/10/2025</span>
    </div>
    <div class="row">
      <span class="muted" id="langLabel">Language</span>
      <button id="btnEn" class="secondary">English</button>
      <button id="btnZh" class="secondary">中文</button>
      <button id="btnAdmin" class="primary">Staff</button>
    </div>
  </div>
</header>

<main class="container" style="padding-top:16px;">
  <section id="pageFlow">
    <div class="card"><div class="content grid">
      <div id="errorBanner" class="chip danger hidden"></div>
      <div id="cloudBanner" class="chip hidden"></div>
      <div id="rosterStatus" class="muted"></div>

      <div>
        <label id="labelSelectClass">Select Class</label>
        <select id="selectClass"><option value="" id="optChoose">Choose</option></select>
      </div>

      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button id="modeNumber" class="primary">Class No.</button>
        <button id="modeName" class="secondary">Choose from list</button>
      </div>

      <div id="panelNumber" class="grid">
        <label id="labelEnterNo">Enter class number (e.g., 12)</label>
        <input id="inputNumber" inputmode="numeric" pattern="[0-9]*" placeholder="12"/>
        <button id="btnConfirmByNo" class="primary">Confirm student</button>
      </div>

      <div id="panelName" class="grid hidden">
        <label id="labelStudentName">Student name</label>
        <select id="selectStudent"><option value="" id="optStudentChoose">Choose a student</option></select>
      </div>
    </div></div>
  </section>

  <div id="cardPicked" class="card hidden"><div class="content grid">
    <div class="xl" id="pickedLine">Student: –</div>
    <div class="muted" id="pickedGroup">Group: –</div>
    <div class="muted">Venue: <span id="pickedVenue" style="font-weight:700"></span></div>
    <div id="alreadyWarn" class="chip danger hidden"></div>
    <div>
      <label id="labelParents">No. of parents attending</label>
      <input
  id="inputParents"
  type="number"
  inputmode="numeric"
  pattern="[0-9]*"
  min="1"
  max="4"
  step="1"
  value="1"
  oninput="var v=parseInt(this.value||'1',10); if(isNaN(v)) v=1; if(v<1) v=1; if(v>4) v=4; this.value=v;">
    </div>
    <div class="row" style="gap:10px;flex-wrap:wrap">
      <button id="btnConfirmAttendance" class="primary">Confirm attendance</button>
      <button id="btnBack" class="secondary">Back</button>
    </div>
  </div></div>

  <div id="cardDone" class="card hidden"><div class="content grid">
    <div class="xl" id="doneTitle">Attendance confirmed</div>
    <div class="muted" id="doneSub">Student: –</div>
    <div class="muted" id="donePrompt">After the briefing, please proceed to your designated room:</div>
    <div class="big" id="doneVenue">M42(4/F)</div>
    <div class="row" style="gap:10px;flex-wrap:wrap">
      <button id="btnDoneBack" class="primary">Back</button>
      <button id="btnDoneReset" class="secondary">Reset</button>
    </div>
  </div></div>

  <!-- Staff (locked) -->
  <section id="pageAdmin" class="hidden">
    <div class="card"><div class="content grid">
      <h2 id="adminTitle">Staff mode</h2>
      <label id="labelPIN">Enter PIN</label>
      <input id="inputPIN" inputmode="numeric"/>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="btnUnlock" class="primary">Unlock</button>
        <button id="btnAdminBack" class="secondary">Back</button>
      </div>
    </div></div>
  </section>

  <!-- Staff (unlocked) -->
  <section id="pageAdminOpen" class="hidden">
    <div class="card"><div class="content grid">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="xl" id="adminOpenTitle">Staff mode</div>
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <button id="btnExport" class="primary">Export CSV (local)</button>
          <button id="btnLock" class="secondary">Lock</button>
        </div>
      </div>
      <div class="two grid">
        <div class="card"><div class="content">
          <div class="muted" id="labelTotalParents">Total parents checked-in</div>
          <div class="big" id="totalParents">0</div>
        </div></div>
        <div class="card"><div class="content">
          <div class="muted" id="labelTotalFamilies">Total families checked-in</div>
          <div class="big" id="totalFamilies">0</div>
        </div></div>
      </div>
      <input id="adminSearch" placeholder="Search…"/>
      <div class="grid" id="adminList"></div>
    </div></div>
  </section>

  <div class="foot">© 2025 F1 Growth Celebration</div>
</main>

<script>
/* ===== CONFIG ===== */
// 1) Paste your Apps Script “Web app” URL here:
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxzjfbVE0LZ-cIeEC9Szmm_cRPKoyBjwnhgZcvPhXEbw6BT9R3ixT23IRu7ApQ7nobSSw/exec'; // e.g. https://script.google.com/macros/s/XXXX/exec
const ADMIN_PIN = '1025';

/* ===== ERRORS ON PAGE ===== */
(function(){
  var shown=false;
  function show(err){
    try{var n=document.getElementById('errorBanner'); if(n && !shown){ n.textContent='Error: '+String(err); n.classList.remove('hidden'); shown=true; }}catch(_){}
  }
  window.addEventListener('error', e=>show(e.message||e.error||'unknown'));
  window.addEventListener('unhandledrejection', e=>show((e&&e.reason)?e.reason:'Promise rejected'));
})();

/* ===== I18N ===== */
var I18N={en:{appTitle:"F1 Growth Celebration Ceremony",language:"Language",staff:"Staff",selectClass:"Select Class",choose:"Choose",chooseStudent:"Choose a student",classNo:"Class No.",searchByName:"Choose from list",enterNumber:"Enter class number (e.g., 12)",studentName:"Student name",noMatch:"No matching student",confirmStudent:"Confirm student",student:"Student",group:"Group",odd:"Odd",even:"Even",parentsAttending:"No. of parents attending",confirmAttendance:"Confirm attendance",attendanceConfirmed:"Attendance confirmed",proceedToVenue:"After the briefing, please proceed to your designated room:",back:"Back",reset:"Reset",admin:"Staff mode",adminPIN:"Enter PIN",unlock:"Unlock",lock:"Lock",exportCSV:"Export CSV",totalParents:"Total parents checked-in",totalFamilies:"Total families checked-in",loadFail:"Could not load roster.xlsx in this folder.",loadSuccess:"Roster loaded. You may check in now.",alreadyCheckedIn:"Already checked in",cloudOn:"Cloud sync ON",cloudOff:"Cloud sync OFF — local only"},zh:{appTitle:"中一成長祝福禮",language:"語言",staff:"職員",selectClass:"選擇班別",choose:"請選擇",chooseStudent:"請選擇學生",classNo:"學號",searchByName:"從名單選擇",enterNumber:"輸入學號（例如：12）",studentName:"學生姓名",noMatch:"找不到相符學生",confirmStudent:"確認學生",student:"學生",group:"組別",odd:"單號",even:"雙號",parentsAttending:"到場家長人數",confirmAttendance:"確認出席",attendanceConfirmed:"已完成簽到",proceedToVenue:"簡介會結束後，請前往指定課室：",back:"返回",reset:"重設",admin:"職員模式",adminPIN:"輸入密碼",unlock:"解鎖",lock:"上鎖",exportCSV:"匯出 CSV",totalParents:"已簽到家長總數",totalFamilies:"已簽到家庭數",loadFail:"未能載入 roster.xlsx。",loadSuccess:"已載入名單，可開始簽到。",alreadyCheckedIn:"已簽到",cloudOn:"雲端同步：開啟",cloudOff:"雲端同步：關閉（只存此裝置）"}};
var state={lang:(localStorage.getItem('f1.lang')||'en'), roster:null, picked:null};
function t(k){return I18N[state.lang][k];}
function el(id){return document.getElementById(id);}
function setText(id,txt){var n=el(id); if(n){n.textContent=txt;}}

/* ===== STORAGE (local fallback) ===== */
function loadCheckins(){try{return JSON.parse(localStorage.getItem('f1.checkins')||'[]')}catch(e){return[]}}
function saveCheckins(v){localStorage.setItem('f1.checkins',JSON.stringify(v))}
function hasCheckedIn(cid,num){var a=loadCheckins();for(var i=0;i<a.length;i++){var r=a[i];if(r.classId===cid&&Number(r.number)===Number(num))return true;}return false}

/* ===== CLOUD ===== */
function cloudEnabled(){return BACKEND_URL && BACKEND_URL.indexOf('script.google.com')>=0;}
function cloudBanner(){var n=el('cloudBanner'); if(!n) return; n.classList.remove('hidden'); n.classList.remove('danger'); n.textContent = cloudEnabled()? (state.lang==='zh'?t('cloudOn'):t('cloudOn')) : (state.lang==='zh'?t('cloudOff'):t('cloudOff')); if(!cloudEnabled()){ n.classList.add('danger'); }}

// POST check-in via URL-encoded body to avoid CORS preflight
function cloudCheckin(record){
  if(!cloudEnabled()) return Promise.resolve({status:'local-only'});
  var body = new URLSearchParams();
  body.set('action','checkin');
  body.set('json', JSON.stringify(record));
  return fetch(BACKEND_URL, {method:'POST', body})
    .then(function(r){return r.json();})
    .catch(function(){return {status:'error'}});
}
function cloudList(){
  if(!cloudEnabled()) return Promise.resolve({status:'ok', items:[]});
  return fetch(BACKEND_URL+'?action=list', {cache:'no-store'}).then(function(r){return r.json();});
}

/* ===== NAMES / LABELS ===== */
function stripZW(s){return String(s||'').replace(/[\u200B\u200C\u200D\uFEFF]/g,'');}
function displayLabelFrom(en,ch){en=stripZW(en||'').trim(); ch=stripZW(ch||'').trim(); return (ch&&en)?(ch+' / '+en):(ch||en||'');}

/* ===== ROSTER BUILD ===== */
function normalizeRow(r){
  var NBSP=String.fromCharCode(160);
  function normKey(k){return String(k||'').toLowerCase().split(NBSP).join(' ').replace(/[\s_]+/g,'').trim();}
  function pickAny(obj,keys){var map={},k;for(k in obj){if(Object.prototype.hasOwnProperty.call(obj,k))map[normKey(k)]=k;}for(var i=0;i<keys.length;i++){var want=normKey(keys[i]);if(map[want]!=null)return obj[map[want]];}return undefined;}
  function toStr(v){return String(v==null?'':v).split(NBSP).join(' ').trim();}
  var cls=toStr(pickAny(r,['class','Class'])); var number=Number(pickAny(r,['number','no','class_no'])||0);
  var en=toStr(pickAny(r,['en_name','English Name','englishname'])); var ch=toStr(pickAny(r,['ch_name','中文姓名','chinesename']));
  var disp=toStr(pickAny(r,['display_name','displayname','Display Name']));
  var groupRaw=String(toStr(pickAny(r,['group','Group']))).toLowerCase();
  var group=groupRaw.indexOf('odd')>=0?'odd':(groupRaw.indexOf('even')>=0?'even':(number%2?'odd':'even'));
  var venue=toStr(pickAny(r,['venue','room','classroom']));
  var parents=Number(pickAny(r,['parents_expected','expected_parents','parents'])||0);
  return {cls:cls,number:number,en_name:en,ch_name:ch,display_name:disp,group:group,venue:venue,parents_expected:(parents>0?parents:0)};
}
function buildData(rows){
  var data={classes:{}};
  for(var i=0;i<rows.length;i++){
    var row=normalizeRow(rows[i]); if(!row.cls||!row.number) continue;
    if(!data.classes[row.cls]) data.classes[row.cls]={odd:{venue:null,students:[]},even:{venue:null,students:[]}};
    var bucket=data.classes[row.cls][row.group]; if(!bucket.venue&&row.venue) bucket.venue=row.venue;
    var disp=(row.display_name&&row.display_name.trim())?row.display_name:displayLabelFrom(row.en_name,row.ch_name); if(!disp) disp='#'+row.number;
    bucket.students.push({number:row.number,en_name:row.en_name,ch_name:row.ch_name,display_name:disp,expected_parents:(row.parents_expected>0?row.parents_expected:null)});
  }
  for(var c in data.classes){var cb=data.classes[c]; cb.odd.students.sort(function(a,b){return a.number-b.number}); cb.even.students.sort(function(a,b){return a.number-b.number});}
  return data;
}

/* ===== XLSX LOAD ===== */
function parseExcelArrayBuffer(buf){var wb=XLSX.read(new Uint8Array(buf),{type:'array'}); var ws=wb.Sheets['roster']||wb.Sheets[wb.SheetNames[0]]; if(!ws) throw new Error('No sheets'); var rows=XLSX.utils.sheet_to_json(ws,{defval:''}); return buildData(rows);}
function loadRosterFromUrl(url){return fetch(url,{cache:'no-store'}).then(function(res){if(!res.ok) throw new Error('HTTP '+res.status); if(/\.json($|\?)/i.test(url)) return res.json(); return res.arrayBuffer().then(parseExcelArrayBuffer);});}

/* ===== UI ===== */
function fillClassSelect(){
  var sel=el('selectClass'); if(!sel) return;
  var keep=sel.value; sel.innerHTML='<option value="" id="optChoose">'+t('choose')+'</option>';
  if(state.roster){var keys=Object.keys(state.roster.classes).sort(); for(var i=0;i<keys.length;i++){var c=keys[i]; var opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);} if(keep&&state.roster.classes[keep]) sel.value=keep; populateStudentsUI();}
}
function populateStudentsUI(){
  var clsSel=el('selectClass'); var cls=clsSel?clsSel.value:''; var sel=el('selectStudent'); if(!sel) return;
  sel.innerHTML='<option value="" id="optStudentChoose">'+t('chooseStudent')+'</option>';
  if(!state.roster||!cls||!state.roster.classes[cls]) return; var cb=state.roster.classes[cls];
  function makeOption(s,group,venue){
    var opt=document.createElement('option'); opt.value=String(s.number);
    var name=displayLabelFrom(s.en_name,s.ch_name); if(!name) name=s.display_name; if(!name) name='#'+s.number;
    var grpText=group==='odd'?t('odd'):t('even'); var text=name+' (#'+s.number+' • '+grpText+')'+(hasCheckedIn(cls,s.number)?' ✓':'');
    opt.label=text; opt.text=text; opt.textContent=text; opt.innerText=text;
    opt.dataset.group=group; opt.dataset.venue=venue||''; opt.dataset.expected=(s.expected_parents!=null)?String(s.expected_parents):'';
    return opt;
  }
  for(var i=0;i<cb.odd.students.length;i++) sel.appendChild(makeOption(cb.odd.students[i],'odd',cb.odd.venue));
  for(var j=0;j<cb.even.students.length;j++) sel.appendChild(makeOption(cb.even.students[j],'even',cb.even.venue));
}

function findByNumber(cls,n){
  var cb=state.roster.classes[cls]; if(!cb) return null; var s,i,l;
  for(i=0;i<cb.odd.students.length;i++){s=cb.odd.students[i]; if(s.number===n){l=displayLabelFrom(s.en_name,s.ch_name)||s.display_name||('#'+n); return {classId:cls,number:n,label:l,group:'odd',venue:cb.odd.venue||'',expected_parents:s.expected_parents};}}
  for(i=0;i<cb.even.students.length;i++){s=cb.even.students[i]; if(s.number===n){l=displayLabelFrom(s.en_name,s.ch_name)||s.display_name||('#'+n); return {classId:cls,number:n,label:l,group:'even',venue:cb.even.venue||'',expected_parents:s.expected_parents};}}
  return null;
}

function updatePickedCard(){
  var c=state.picked; if(!c){el('cardPicked').classList.add('hidden');return;}
  setText('pickedLine', t('student')+': '+c.label+' ('+c.classId+' #'+c.number+')');
  setText('pickedGroup', t('group')+': '+(c.group==='odd'?t('odd'):t('even')));
  setText('pickedVenue', c.venue||'');
  var exists=false; // server decides real duplicates; local only for hint
  var warn=el('alreadyWarn'), btn=el('btnConfirmAttendance'), ip=el('inputParents');
  if(exists){ if(warn){warn.textContent=t('alreadyCheckedIn'); warn.classList.remove('hidden');} if(btn) btn.disabled=true; }
  else { if(warn) warn.classList.add('hidden'); if(btn) btn.disabled=false; if(ip) ip.value=(c.expected_parents&&Number(c.expected_parents)>0)?String(c.expected_parents):'1'; }
  el('cardPicked').classList.remove('hidden');
}

function confirmAttendance(){
  var p = Math.min(4, Math.max(1, parseInt((el('inputParents') && el('inputParents').value) || '1', 10) || 1));
  var c=state.picked; if(!c) return;
  var record={ ts:Date.now(), classId:c.classId, number:c.number, name:c.label, group:c.group, venue:c.venue, parents:p, lang:state.lang };
  // Send to cloud first
  cloudCheckin(record).then(function(resp){
    if(resp && resp.status==='duplicate'){
      setText('doneTitle', t('alreadyCheckedIn'));
    } else if(resp && resp.status==='ok'){
      setText('doneTitle', t('attendanceConfirmed'));
    } else if(resp && resp.status==='local-only'){
      // No backend configured: fall back to local storage
      var list=loadCheckins(); list.push(record); saveCheckins(list);
      setText('doneTitle', t('attendanceConfirmed')+' (local)');
    } else {
      // Network error: store locally to avoid losing the parent
      var list2=loadCheckins(); list2.push(record); saveCheckins(list2);
      setText('doneTitle', t('attendanceConfirmed')+' (saved locally – will not appear in Staff totals)');
    }
    setText('doneSub', t('student')+': '+c.label+' ('+c.classId+' #'+c.number+') • '+t('group')+': '+(c.group==='odd'?t('odd'):t('even')));
    setText('doneVenue', c.venue);
    el('cardPicked').classList.add('hidden'); el('cardDone').classList.remove('hidden');
    state.picked=null;
  });
}

/* ===== STAFF ===== */
function refreshAdmin(){
  // Prefer cloud list; fallback to local
  cloudList().then(function(resp){
    var list = (resp && resp.items) ? resp.items : loadCheckins();
    var q=(el('adminSearch')&&el('adminSearch').value||'').toLowerCase();
    list = list.filter(function(r){
      var s=[r.name,r.classId,String(r.number),r.venue,r.group].join(' ').toLowerCase();
      return !q || s.indexOf(q)>=0;
    });
    var totalParents=0; for(var i=0;i<list.length;i++) totalParents+=Number(list[i].parents)||0;
    setText('totalParents', String(totalParents));
    setText('totalFamilies', String(list.length));
    var root=el('adminList'); if(root){ root.innerHTML=''; for(var j=0;j<list.length;j++){ var r=list[j]; var item=document.createElement('div'); item.className='card'; item.innerHTML='<div class="content"><div style="font-weight:600">'+r.name+' ('+r.classId+' #'+r.number+')</div><div class="muted" style="font-size:12px">'+(r.timestamp_iso || new Date().toLocaleString())+' • '+r.group+' • '+r.venue+'</div><div class="big">×'+r.parents+'</div></div>'; root.appendChild(item);} }
  });
}

function exportCSV(){
  var rows=loadCheckins(), headers=["timestamp_iso","class","number","name","group","venue","parents","lang"], lines=[headers.join(",")];
  for(var i=0;i<rows.length;i++){ var r=rows[i]; var iso=new Date(r.ts).toISOString(); var vals=[iso,r.classId,r.number,r.name,r.group,r.venue,r.parents,r.lang].map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}); lines.push(vals.join(',')); }
  var blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob), a=document.createElement('a'); a.href=url; a.download='f1_checkins_'+new Date().toISOString().slice(0,10)+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===== BOOT ===== */
function updateRosterStatus(){ setText('rosterStatus', state.roster ? t('loadSuccess') : t('loadFail')); }
function tryAutoLoad(){
  if(state.roster){ fillClassSelect(); updateRosterStatus(); return; }
  var params=new URLSearchParams(location.search);
  var rosterParam=params.get('roster')||params.get('xls')||params.get('excel');
  var base=location.pathname.replace(/[^/]+$/,''); function abs(p){return (p.charAt(0)==='/'?p:base+p).replace(/\/{2,}/g,'/');}
  var candidates=[]; if(rosterParam){candidates.push(abs(rosterParam));candidates.push('./'+rosterParam);} candidates=candidates.concat([abs('roster.xlsx'),'./roster.xlsx']);
  var status=el('rosterStatus'); var lastErr=null;
  (function seq(i){
    if(i>=candidates.length){ if(status){ status.textContent=t('loadFail')+(lastErr?(' ('+lastErr+')'):''); } return; }
    var url=candidates[i]; if(status){status.textContent='Trying '+url+' …';}
    loadRosterFromUrl(url).then(function(d){state.roster=d; localStorage.setItem('f1.roster',JSON.stringify(d)); if(status){status.textContent='Loaded from '+url;} fillClassSelect(); updateRosterStatus();}).catch(function(err){ lastErr=(err&&err.message)||String(err); seq(i+1);});
  })(0);
}

window.addEventListener('DOMContentLoaded', function(){
  // i18n labels
  setText('title',t('appTitle')); setText('langLabel',t('language')); setText('btnAdmin',t('staff'));
  setText('labelSelectClass',t('selectClass')); setText('optChoose',t('choose'));
  setText('modeNumber',t('classNo')); setText('modeName',t('searchByName'));
  setText('labelEnterNo',t('enterNumber')); setText('btnConfirmByNo',t('confirmStudent'));
  setText('labelStudentName',t('studentName')); setText('labelParents',t('parentsAttending'));
  setText('btnConfirmAttendance',t('confirmAttendance')); setText('btnBack',t('back'));
  setText('doneTitle',t('attendanceConfirmed')); setText('donePrompt',t('proceedToVenue'));
  setText('btnDoneBack',t('back')); setText('btnDoneReset',t('reset'));
  setText('adminTitle',t('admin')); setText('labelPIN',t('adminPIN')); setText('btnUnlock',t('unlock'));
  setText('btnAdminBack',t('back')); setText('adminOpenTitle',t('admin')); setText('btnExport',t('exportCSV'));
  setText('btnLock',t('lock')); setText('labelTotalParents',t('totalParents')); setText('labelTotalFamilies',t('totalFamilies'));
  setText('optStudentChoose',t('chooseStudent'));
  cloudBanner();

  // Language switches
  var btnEn=el('btnEn'); if(btnEn) btnEn.addEventListener('click', function(){state.lang='en';localStorage.setItem('f1.lang','en');location.reload();});
  var btnZh=el('btnZh'); if(btnZh) btnZh.addEventListener('click', function(){state.lang='zh';localStorage.setItem('f1.lang','zh');location.reload();});

  // Admin lock/unlock
  var btnAdmin=el('btnAdmin'); if(btnAdmin) btnAdmin.addEventListener('click', function(){el('pageAdmin').classList.remove('hidden');});
  var btnAdminBack=el('btnAdminBack'); if(btnAdminBack) btnAdminBack.addEventListener('click', function(){el('pageAdmin').classList.add('hidden');});
  var btnUnlock=el('btnUnlock'); if(btnUnlock) btnUnlock.addEventListener('click', function(){ if(el('inputPIN').value===ADMIN_PIN){ el('pageAdmin').classList.add('hidden'); el('pageAdminOpen').classList.remove('hidden'); refreshAdmin(); /* auto refresh while open */ if(!window._admTimer){ window._admTimer=setInterval(refreshAdmin, 8000);} }});
  var btnLock=el('btnLock'); if(btnLock) btnLock.addEventListener('click', function(){ el('pageAdminOpen').classList.add('hidden'); if(window._admTimer){clearInterval(window._admTimer); window._admTimer=null;}});
  var adminSearch=el('adminSearch'); if(adminSearch) adminSearch.addEventListener('input', refreshAdmin);
  var btnExport=el('btnExport'); if(btnExport) btnExport.addEventListener('click', exportCSV);

  // Mode switches
  var modeNumber=el('modeNumber'), modeName=el('modeName');
  if(modeNumber) modeNumber.addEventListener('click', function(){el('panelNumber').classList.remove('hidden'); el('panelName').classList.add('hidden'); modeNumber.classList.add('primary'); modeName.classList.remove('primary'); modeName.classList.add('secondary');});
  if(modeName) modeName.addEventListener('click', function(){el('panelName').classList.remove('hidden'); el('panelNumber').classList.add('hidden'); modeName.classList.add('primary'); modeNumber.classList.remove('primary'); modeNumber.classList.add('secondary');});

  // Confirm by number
  var btnConfirmByNo=el('btnConfirmByNo'); if(btnConfirmByNo) btnConfirmByNo.addEventListener('click', function(){
    var cls=el('selectClass').value; var n=Number(el('inputNumber').value||0);
    if(!cls||!n||!state.roster){ alert(t('noMatch')); return; }
    var res=findByNumber(cls,n); if(res){state.picked=res; el('cardDone').classList.add('hidden'); updatePickedCard();} else { alert(t('noMatch')); }
  });

  // Dropdown by name
  var selectStudent=el('selectStudent'); if(selectStudent) selectStudent.addEventListener('change', function(){
    var cls=el('selectClass').value; var val=selectStudent.value;
    if(!cls||!val||!state.roster) return;
    var res=findByNumber(cls, Number(val)); if(res){state.picked=res; el('cardDone').classList.add('hidden'); updatePickedCard();}
  });

  // Confirm/back
  var btnConfirmAttendance=el('btnConfirmAttendance'); if(btnConfirmAttendance) btnConfirmAttendance.addEventListener('click', confirmAttendance);
  var btnBack=el('btnBack'); if(btnBack) btnBack.addEventListener('click', function(){ state.picked=null; el('cardPicked').classList.add('hidden'); });
  var btnDoneBack=el('btnDoneBack'); if(btnDoneBack) btnDoneBack.addEventListener('click', function(){ el('cardDone').classList.add('hidden'); });
  var btnDoneReset=el('btnDoneReset'); if(btnDoneReset) btnDoneReset.addEventListener('click', function(){ el('cardDone').classList.add('hidden'); el('selectClass').value=''; el('inputNumber').value=''; el('selectStudent').value=''; });

  // Class changed
  var selectClass=el('selectClass'); if(selectClass) selectClass.addEventListener('change', function(){
    el('inputNumber').value=''; el('selectStudent').value=''; state.picked=null; el('cardPicked').classList.add('hidden'); el('cardDone').classList.add('hidden'); populateStudentsUI();
  });

  // Cache roster and load
  try{var cached=JSON.parse(localStorage.getItem('f1.roster')||'null'); if(cached) state.roster=cached;}catch(e){}
  fillClassSelect(); setText('rosterStatus','Loading roster.xlsx…'); tryAutoLoad();
});
</script>
</body>
</html>
